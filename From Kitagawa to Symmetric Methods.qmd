---
format: html
editor: visual
code-fold: true
warning: false
editor_options: 
  chunk_output_type: console
---

# **From Kitagawa to Symmetric Methods**

Autores: Emerson (PI), Marcial y Caro

## Introducción

Este trabajo forma parte de un proyecto de investigación cuyo objetivo es analizar una doble vulnerabilidad frente al calor: la discapacidad y la vejez. Analíticamente, buscamos abordar una triple intersección entre tres dimensiones discapacidad (d), estructura por edad (s) y exposición al calor (h).

![](Intersection.png){fig-align="center"}

El propósito es identificar las diferencias regionales en la exposición al vivir el calor teniendo discapacidad, utilizando métodos de descomposición de tasas. En una primera etapa, aplicamos el método clásico de Kitagawa (1955) para examinar pares de componentes dentro de esta triple intersección:

-   estructura por edad y discapacidad (s–d),

-   estructura por edad y calor (s–h),

-   discapacidad y calor (d–h).

Posteriormente, emplearemos métodos simétricos de descomposición (Das Gupta, Horiuchi, y Stepwise Replacement) para descomponer simultáneamente los tres componentes (s–d–h) y estimar la contribución de cada uno a las diferencias observadas entre regiones.

Estructura analítica:

1\. Tasa y composición

1.1. Kitagawa: discapacidad (d) y estructura por edad (s)

1.2. Kitagawa: calor (h) y estructura por edad (s)

1.3. Kitagawa: calor (h) y discapacidad (d)

2\. Métodos Simétricos: Das Gupta, Horiuchi y Stepwise Replacement

## Paquetes

A continuación se cargan los paquetes necesarios:

```{r}
#| code-fold: false
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
    #Decomposition functions
    DemoDecomp,
    gtools, # permutations function for DasGupta's method 
    
    #Manipulation & analysis
    readr,readxl,
    janitor, dplyr,
    tidyr, tidyverse,
    purrr, # easy iterations
    scales, # Format numbers in graphics
    knitr, # Integrate code and narrative inside documents
    gt,#  Produce professional-quality tables
    
    # Data Viz
    ggplot2, patchwork,
    
    # For Spatial Data
    sf, ggmap, biscale)
```

## Funciones

### Kitagawa generalizada

Let $x$ index the stratification categories of any structurally relevant variable—age groups, educational levels, socioeconomic strata, household types, regions of residence, and so on.

Let $G$ denote ny population or group for which we aim to compute and compare an aggregate rate.

For each $(G, x)$pair, we define:

1.  Size of the stratum

$$\eta_x^{(G)} : \text{total number of units in structural category } x \text{ within group } G.$$

2.  Structural weight of the stratum

$$s_x^{(G)} = \frac{\eta_x^{(G)}}{\sum_x \eta_x^{(G)}}.$$

3.  Stratum-specific rate

$$r_x^{(G)} : \text{rate, proportion, or intensity associated with stratum } x.$$

The overall rate of group $G$ is always a weighted average:

$$R^{(G)} = \sum_x s_x^{(G)} \, r_x^{(G)}.$$

Comparison between two populations

Let $A$ and $B$ be any two groups. The total difference in overall rates is:

$$\Delta R = R^{(A)} - R^{(B)}.$$

The classical **Kitagawa (1955)** method separates these two sources of variation through an additive and symmetric decomposition:

$$\Delta R = \sum_x \left(r_x^{(A)} - r_x^{(B)}\right) \frac{s_x^{(A)} + s_x^{(B)}}{2} + \sum_x \left(s_x^{(A)} - s_x^{(B)}\right) \frac{r_x^{(A)} + r_x^{(B)}}{2}.$$

$$\underbrace{\sum_x \left(r_x^{(A)} - r_x^{(B)}\right) \frac{s_x^{(A)} + s_x^{(B)}}{2}}_{\text{Rate Effect (RE)}} + \underbrace{\sum_x \left(s_x^{(A)} - s_x^{(B)}\right) \frac{r_x^{(A)} + r_x^{(B)}}{2}}_{\text{Composition Effect (CE)}}.$$

This total difference may arise from:

1.  changes in the **stratum-specific rates**, capturing how much of the total difference is due to variation in the specific rates across strata while holding the structure fixed. This is the “pure” component reflecting changes in the risk or intensity of the outcome of interest.

2.  changes in the **structural composition**, measuring the portion explained by differences in the group’s structure (age, education, region, etc.). Its generic interpretation is:

    *“How much would the overall rate change if the groups shared the same structural composition but kept their own stratum-specific rates?”*

### Función genérica

\[Pendiente: Revisar y confirmar que los porcentajes o relativos tal como son calculados permiten la mejor interpretación\]

```{r}
kitagawa_generic <- function(
  data,
  group_col, # ejemplo: "region"
  stratum_col, # ejemplo: "age"
  ref, # ejemplo: "Nacional"
  cmp, # ejemplo: "Noreste"
  rate_col = NULL, # ejemplo: "d"
  struct_col = NULL, # ejemplo: "s"
  return = c("summary","by_stratum","both") # qué devolver
){
  return <- match.arg(return)

# Datos por grupo y estrato
  df <- data |>
    dplyr::select(
      !!group_col := dplyr::all_of(group_col),
      !!stratum_col := dplyr::all_of(stratum_col),
      dplyr::all_of(c(rate_col, struct_col)) |> stats::na.omit()
    )

  # Extraemos A y B (ref y cmp)
  A <- df |>
    dplyr::filter(.data[[group_col]] == ref) |>
    dplyr::select(
      !!stratum_col := dplyr::all_of(stratum_col),
      r_A = dplyr::all_of(rate_col),
      s_A = dplyr::all_of(struct_col)
    )

  B <- df |>
    dplyr::filter(.data[[group_col]] == cmp) |>
    dplyr::select(
      !!stratum_col := dplyr::all_of(stratum_col),
      r_B = dplyr::all_of(rate_col),
      s_B = dplyr::all_of(struct_col)
    )

  merged <- dplyr::full_join(A, B, by = stratum_col) |>
    dplyr::mutate(dplyr::across(
      .cols = c(r_A, r_B, s_A, s_B),
      ~ tidyr::replace_na(.x, 0)
    )) |>
    dplyr::mutate(
      C_rate = (r_A - r_B) * (s_A + s_B) / 2,
      C_comp = (s_A - s_B) * (r_A + r_B) / 2,
      cont_R_A = r_A * s_A,
      cont_R_B = r_B * s_B
    )

  # Resumen global
  summary_out <- merged |>
    dplyr::summarise(
      R_A = sum(cont_R_A, na.rm = TRUE),
      R_B = sum(cont_R_B, na.rm = TRUE),
      diff_total = R_A - R_B,
      RE = sum(C_rate, na.rm = TRUE),
      CE = sum(C_comp, na.rm = TRUE)) |>
      ungroup() |> 
    dplyr::mutate(
      ref = ref,
      cmp = cmp,
      # Relativos
      pct_RE = dplyr::if_else(
          diff_total != 0, 100 * RE / diff_total, NA_real_),
      pct_CE = dplyr::if_else(
          diff_total != 0, 100 * CE / diff_total, NA_real_)
    ) |>
    dplyr::relocate(ref, cmp)

  # Resumen por estrato
  by_stratum_out <- merged |>
      select(-r_A, -s_A, -r_B, -s_B) |> 
      dplyr::mutate(
      !!stratum_col := .data[[stratum_col]],
      ref = ref,
      cmp = cmp) |> 
      group_by(cmp) |> 
      mutate(
      R_A = sum(cont_R_A, na.rm = TRUE),
      R_B = sum(cont_R_B, na.rm = TRUE),
      diff_total = R_A - R_B) |> 
      ungroup() |> 
      dplyr::mutate(
      diff = cont_R_A - cont_R_B) |> 
      rename(
          RE = C_rate,
          CE = C_comp) |> 
      # Relativos
      mutate(
      pct_RE = dplyr::if_else(
          diff != 0, 100 * RE / diff_total, NA_real_),
      pct_CE = dplyr::if_else(
          diff != 0, 100 * CE / diff_total, NA_real_),
      pct_STRATUM = pct_RE+pct_CE
      ) |> 
      dplyr::relocate(ref, cmp)

  # Opción de salida:
  if (return == "summary") return(summary_out)
  if (return == "by_stratum") return(by_stratum_out)
  list(summary = summary_out, by_stratum = by_stratum_out)
}
```

### Replicar Kitagawa vs referencia

Esto permite un data.frame con los resúmenes de varios categorías (cmp) especificando solo una como referencia

```{r}
kitagawa_vs_ref <- function(
  data, group_col, stratum_col, ref,
  rate_col = NULL, struct_col = NULL,
  return = c("summary","by_stratum","both")
){
    return <- match.arg(return)
  grupos <- setdiff(unique(data[[group_col]]), ref)
  purrr::map_dfr(grupos, \(g)
    kitagawa_generic(
      data, group_col, stratum_col, ref = ref, cmp = g,
      rate_col = rate_col, struct_col = struct_col,
      return = return
    ) |>
      dplyr::mutate(!!group_col := g)
  ) |>
    dplyr::relocate(dplyr::all_of(group_col), .after = cmp)
}
```

## Datos

Cargamos base de datos de población y discapacidad

```{r}
df <- read_excel("in/POP_UTCI_mun.xlsx")

mapa <- sf::read_sf("in/mapa_ent_small.shp")

df <- df |> 
    left_join(mapa |>
                  st_drop_geometry() |> 
                  select(cve_ent = CVE_ENT, NOMGEO),
              by = "cve_ent")


# Nuevas categorías de discapacidad usadas
df <- df |> 
    mutate(dis_mov = dis_caminar+dis_banarse,
           dis_otros = dis_ver+dis_oir+dis_recordar+dis_hablar)

#Unidad de comparación
df <- df |> 
    select(-region) |> 
    rename(region = NOMGEO)
```

## Resultados

### 1. Tasa y composición

#### 1.1. Kitagawa: discapacidad (d) y vejez (s)

-   Medida de comparación: tasa de discapacidad = Σ(s·d)

    -   *s*: distribución de la población por edad (estructura etaria).

    -   *d*: prevalencia de discapacidad específica por edad.

Esta parte del análisis permitirá identificar en qué medida las diferencias regionales en la tasa de discapacidad se deben a la estructura etaria o a la prevalencia específica por edad.

##### Agregación en datos en dos componentes (s y d):

```{r}
age5_levels <-  c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+")


discapacidades <- c(
     "popdis",
     "dis_mov",
     "dis_mult",
     "dis_otros")

datos <- list()

for (i in discapacidades) {
    
estatal <- df |>
  group_by(region, age5) |>
  summarise(
    S = sum(pop, na.rm = TRUE),
    D = sum(.data[[i]], na.rm = TRUE)
  ) |> ungroup() |> 
    group_by(region) |> 
  mutate(
    d = D / S, # tasa específica de discapacidad
    s = S / sum(S, na.rm = TRUE)) |> # estructura etaria
  ungroup()

# Nacional
nacional <- df |>
  group_by(age5) |>
  summarise(
    S = sum(pop, na.rm = TRUE),
    D = sum(.data[[i]], na.rm = TRUE)
  ) |> ungroup() |> 
  mutate(
    region = "Nacional",
    d = D / S,
    s = S / sum(S, na.rm = TRUE))

datos[[i]] <- bind_rows(estatal, nacional) |> 
    mutate(discapacidad = i)

}

#datos[[1]] |> View()
```

#### Descomposición (s y d):

Empezamos por ver discapcidad por edad

```{r}
# Comparar tasas de discapacidad (severa) Nacional vs Región
resumen <- kitagawa_vs_ref(
  data        = datos[[1]],
  group_col   = "region",
  stratum_col = "age5",
  ref         = "Nacional",
  rate_col    = "d",
  struct_col  = "s"
)

resumen_edad <- kitagawa_vs_ref(
  data        = datos[[1]],
  group_col   = "region",
  stratum_col = "age5",
  ref         = "Nacional",
  rate_col    = "d",
  struct_col  = "s",
  return  = "by_stratum"
)
```

\[Pendiente: Replicar el for para obtener resultados de cada tipo de discapacidad (aunque está pendiente agrupar discapacidades)\]

```{r}
# Comparar tasas de discapacidad por tipo Nacional vs Región
# Todos menos el primero 2:4
resumen <- list()
resumen_edad <- list()

for (i in 1:4) {
resumen[[i]] <- kitagawa_vs_ref(
  data        = datos[[i]],
  group_col   = "region",
  stratum_col = "age5",
  ref         = "Nacional",
  rate_col    = "d",
  struct_col  = "s") |> 
    mutate(discapacidad = discapacidades[[i]])

resumen_edad[[i]] <- kitagawa_vs_ref(
  data        = datos[[i]],
  group_col   = "region",
  stratum_col = "age5",
  ref         = "Nacional",
  rate_col    = "d",
  struct_col  = "s",
  return  = "by_stratum") |> 
    mutate(discapacidad = discapacidades[[i]])
}

resumen <- do.call(rbind, resumen)
resumen_edad <- do.call(rbind, resumen_edad)
```

Plots

```{r}
resumen |>
  tidyr::pivot_longer(c(RE, CE), 
                      names_to = "effect_type",
                      values_to = "value") |>
  dplyr::mutate(
    effect_type = dplyr::recode(
        effect_type,
        "RE" = "Efecto tasa (RE)",
        "CE" = "Efecto composición (CE)")) |>
    dplyr::mutate(
    discapacidad = dplyr::recode(
        discapacidad,
        "popdis" = "Severe",
        "dis_mov" = "Movilidad",
        "dis_mult" = "Múltiple",
        "dis_otros" = "Otros")) |>
    filter(discapacidad != "Severe") |> 
    group_by(region) |> 
    mutate(sum_diff = sum(diff_total)) |> ungroup() |> 
  ggplot(aes(x = value,
             y = fct_reorder(region, sum_diff),
             fill = discapacidad,
             color = effect_type,
             group = effect_type)) +
    geom_col(position = "stack", alpha = .5,
             linewidth = .5) +
  labs(
    x = "Contribución a ΔR (p.p.)", y = NULL,
    #title = paste0("Nacional vs Region"),
    subtitle = "Tipos de discapacidad",
    fill = NULL, color = NULL
  ) +
     scale_fill_manual(values = c(
        #"Severe" ="#4682B4",
        "Movilidad"= "#7fc97f",
        "Múltiple"= "#beaed4",
        "Otros" = "#fdc086")) +
     scale_color_manual(values = c(
      "Efecto tasa (RE)" = "black",
      "Efecto composición (CE)" = "red")) +
    #facet_wrap(~discapacidad, ncol = 6)+
    theme_bw()+
    theme(legend.position = "bottom")

resumen |>
  tidyr::pivot_longer(c(RE, CE), 
                      names_to = "effect_type",
                      values_to = "value") |>
  dplyr::mutate(
    effect_type = dplyr::recode(
        effect_type,
        "RE" = "Efecto tasa (RE)",
        "CE" = "Efecto composición (CE)")) |>
    dplyr::mutate(
    discapacidad = dplyr::recode(
        discapacidad,
        "popdis" = "Severe",
        "dis_mov" = "Movilidad",
        "dis_mult" = "Múltiple",
        "dis_otros" = "Otros")) |>
    filter(discapacidad == "Severe") |> 
    group_by(region) |> 
    mutate(sum_diff = sum(diff_total)) |> ungroup() |> 
  ggplot(aes(x = value,
             y = fct_reorder(region, sum_diff),
             #fill = discapacidad,
             color = effect_type,
             group = effect_type)) +
    geom_col(position = "stack", fill = "white") +
    scale_color_manual(values = c(
      "Efecto tasa (RE)" = "black",
      "Efecto composición (CE)" = "red")) +
  labs(
    x = "Contribución a ΔR (p.p.)", y = NULL,
    #title = paste0("Nacional vs Region"),
    subtitle = "Discapacidad severa",
    fill = NULL,
    color = NULL) +
    #facet_wrap(~discapacidad, ncol = 6)+
    theme_bw()+
    theme(legend.position = "bottom")
```

**Por edad**

```{r}
plot_edad_dis <- resumen_edad |>
  tidyr::pivot_longer(c(RE, CE), 
                      names_to = "effect_type",
                      values_to = "value") |>
  dplyr::mutate(
    effect_type = dplyr::recode(
        effect_type,
        "RE" = "Efecto tasa (RE)",
        "CE" = "Efecto composición (CE)")) |>
    dplyr::mutate(
    discapacidad = dplyr::recode(
        discapacidad,
        "popdis" = "Severe",
        "dis_mov" = "Movilidad",
        "dis_mult" = "Múltiple",
        "dis_otros" = "Otros")) |>
    mutate(age5 = factor(age5, c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+"))) |> 
    filter(discapacidad != "Severe") |> 
    group_by(region) |> 
    mutate(sum_diff = sum(diff_total)) |> ungroup() |> 
  ggplot(aes(x = value,
             y = age5,
             fill = discapacidad,
             color = effect_type,
             group = effect_type)) +
    geom_col(position = "stack") +
  labs(
    x = "Contribución a ΔR (p.p.)", y = NULL,
    #title = paste0("Nacional vs Region"),
    subtitle = "Tipos de discapacidad",
    fill = NULL, color = NULL) +
     scale_fill_manual(values = c(
        #"Severe" ="#4682B4",
        "Movilidad"= "#7fc97f",
        "Múltiple"= "#beaed4",
        "Otros" = "#fdc086")) +
     scale_color_manual(values = c(
      "Efecto tasa (RE)" = "black",
      "Efecto composición (CE)" = "red")) +
    facet_wrap(~fct_reorder(region, sum_diff),
               ncol = 4)+
    theme_bw()+
    theme(legend.position = "bottom")

plot_edad_dis


plot_edad <- resumen_edad |>
  tidyr::pivot_longer(c(RE, CE), 
                      names_to = "effect_type",
                      values_to = "value") |>
  dplyr::mutate(
    effect_type = dplyr::recode(
        effect_type,
        "RE" = "Efecto tasa (RE)",
        "CE" = "Efecto composición (CE)")) |>
    dplyr::mutate(
    discapacidad = dplyr::recode(
        discapacidad,
        "popdis" = "Severe",
        "dis_mov" = "Movilidad",
        "dis_mult" = "Múltiple",
        "dis_otros" = "Otros")) |>
    mutate(age5 = factor(age5, c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+"))) |> 
    filter(discapacidad == "Severe") |> 
    group_by(region) |> 
    mutate(sum_diff = sum(diff_total)) |> ungroup() |> 
  ggplot(aes(x = value,
             y = age5,
             color = effect_type,
             group = effect_type)) +
    geom_col(position = "stack", fill = "white") +
  labs(
    x = NULL, y = NULL,
    #title = paste0("Nacional vs Region"),
    subtitle = "Discapacidad Severa",
    fill = NULL, color = NULL) +
     scale_color_manual(values = c(
      "Efecto tasa (RE)" = "black",
      "Efecto composición (CE)" = "red")) +
    facet_wrap(~fct_reorder(region, sum_diff),
               ncol = 4)+
    theme_bw()+
    theme(legend.position = "bottom")
plot_edad
#plot_edad/plot_edad_dis
```

#### 1.2. Kitagawa: calor (h) y vejez (s)

-   Medida de comparación: proporción de días de calor = Σ(s·h).

    -   *s*: estructura por edad.

    -   *h*: número promedio de días de calor extremo por edad, agregados a nivel regional con datos municipales.

Con ello se busca estimar cuánto de la exposición promedio al calor se explica por diferencias en la composición etaria regional.

##### Agregación en datos en dos componentes (s y h):

```{r}
# Estados
estatal <- df |>
  group_by(region, age5) |>
  summarise(
    S = sum(pop*366, na.rm = TRUE), # En días-persona
    H = sum(pop*heatdays, na.rm = TRUE), # En días-persona
    ) |> ungroup() |> 
    group_by(region) |> 
  mutate(
    h = H / S, # proporción específica de días calor
    s = S / sum(S, na.rm = TRUE)) |> # estructura etaria
    # Solo para ver los días al año recurrimos a esta ponderación
  mutate(heat_days = sum(h*s)*366) |> 
    ungroup() 
    

# Nacional
nacional <- df |>
    group_by(age5) |>
  summarise(
    S = sum(pop*366, na.rm = TRUE), # En días-persona
    H = sum(pop*heatdays, na.rm = TRUE), # En días-persona
    ) |> ungroup() |> 
  mutate(
    h = H / S, # proporción específica de días calor
    s = S / sum(S, na.rm = TRUE)) |> # estructura etaria
    # Días al año
  mutate(region = "Nacional",
         heat_days = sum(h*s)*366)

datos <- bind_rows(estatal, nacional)
```

#### Descomposición s y h

```{r}
# Comparar proporcio de dias de calor Nacional vs Región
resumen <- kitagawa_vs_ref(
  data        = datos,
  group_col   = "region",
  stratum_col = "age5",
  ref         = "Nacional",
  rate_col    = "h",
  struct_col  = "s"
)

resumen_edad <- kitagawa_vs_ref(
  data        = datos,
  group_col   = "region",
  stratum_col = "age5",
  ref         = "Nacional",
  rate_col    = "h",
  struct_col  = "s",
  return  = "by_stratum"
)
```

Comentarios:

Plots:

```{r}
resumen |>
  tidyr::pivot_longer(c(RE, CE), 
                      names_to = "effect_type",
                      values_to = "value") |>
  dplyr::mutate(
    effect_type = dplyr::recode(
        effect_type,
        "RE" = "Efecto tasa (RE)",
        "CE" = "Efecto composición (CE)")) |>
    group_by(region) |> 
    mutate(sum_diff = sum(diff_total)) |> ungroup() |> 
  ggplot(aes(x = value,
             y = fct_reorder(region, sum_diff),
             color = effect_type,
             group = effect_type)) +
    geom_col(position = "stack", fill = "white") +
    scale_color_manual(values = c(
      "Efecto tasa (RE)" = "black",
      "Efecto composición (CE)" = "red")) +
  labs(
    x = "Contribución a ΔR (p.p.)", y = NULL,
    #title = paste0("Nacional vs Region"),
    subtitle = "Calor y discapacidad",
    fill = NULL, color = NULL) +
    #facet_wrap(~discapacidad, ncol = 6)+
    theme_bw()+
    theme(legend.position = "bottom")
```

Por edad

```{r}
resumen_edad |>
  tidyr::pivot_longer(c(RE, CE), 
                      names_to = "effect_type",
                      values_to = "value") |>
  dplyr::mutate(
    effect_type = dplyr::recode(
        effect_type,
        "RE" = "Efecto tasa (RE)",
        "CE" = "Efecto composición (CE)")) |>
    mutate(age5 = factor(age5, c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+"))) |> 
    group_by(region) |> 
    mutate(sum_diff = sum(diff_total)) |> ungroup() |> 
  ggplot(aes(x = value,
             y = age5,
             color = effect_type,
             group = effect_type)) +
    geom_col(position = "stack", fill = "white") +
  labs(
    x = "Contribución a ΔR (p.p.)", y = NULL,
    #title = paste0("Nacional vs Region"),
    subtitle = "Discapacidad Severa",
    fill = NULL, color = NULL) +
     scale_color_manual(values = c(
      "Efecto tasa (RE)" = "black",
      "Efecto composición (CE)" = "red")) +
    facet_wrap(~fct_reorder(region, sum_diff),
               ncol = 4)+
    theme_bw()+
    theme(legend.position = "bottom")
```

#### 1.3. Kitagawa: calor (h) y discapacidad (d)

-   Medida de comparación: proporción de días de calor = Σ(d·h)

    -   *d*: estructura de la población según discapacidad (dos categorías: con y sin discapacidad).

    -   *h*: días de calor promedio para cada categoría, agregados a nivel regional.

Este análisis permitirá observar si las regiones con mayor exposición térmica de personas con discapacidad lo deben principalmente a la frecuencia del calor o a la distribución de dicha población.

##### Agregación en datos en dos componentes (d y h):

```{r}
# Formato long
df_long <- df |> 
    mutate(popnodis = pop-popdis) |> 
    select(-pop) |> 
    pivot_longer(
        cols = c(
            "popnodis", "dis_mov","dis_mult","dis_otros"),
        names_to = "dis",
        values_to = "pop")

# Estados
estatal <- df_long |>
  group_by(region, dis) |>
  summarise(
    D = sum(pop*366, na.rm = TRUE), # En días-persona
    H = sum(pop*heatdays, na.rm = TRUE), # En días-persona
    ) |> ungroup() |> 
    group_by(region) |> 
  mutate(
    h = H / D, # proporción específica de días calor
    d = D / sum(D, na.rm = TRUE)) |> # estructura etaria
    # Solo para ver los días al año recurrimos a esta ponderación
  mutate(heat_days = sum(h*d)*366) |> 
    ungroup() 
    

# Nacional
nacional <- df_long |>
    group_by(dis) |>
  summarise(
    D = sum(pop*366, na.rm = TRUE), # En días-persona
    H = sum(pop*heatdays, na.rm = TRUE), # En días-persona
    ) |> ungroup() |> 
  mutate(
    h = H / D, # proporción específica de días calor
    d = D / sum(D, na.rm = TRUE)) |> # estructura de discapacidad
    # Días al año
  mutate(region = "Nacional",
         heat_days = sum(h*d)*366)

datos <- bind_rows(estatal, nacional)
```

#### Descomposición d y h

```{r}
# Comparar proporcio de dias de calor Nacional vs Región
resumen <- kitagawa_vs_ref(
  data        = datos,
  group_col   = "region",
  stratum_col = "dis",
  ref         = "Nacional",
  rate_col    = "h",
  struct_col  = "d"
)

resumen_discapacidad <- kitagawa_vs_ref(
  data        = datos,
  group_col   = "region",
  stratum_col = "dis",
  ref         = "Nacional",
  rate_col    = "h",
  struct_col  = "d",
  return  = "by_stratum"
)
```

Comentarios:

Plots

```{r}
resumen |>
  tidyr::pivot_longer(c(RE, CE), 
                      names_to = "effect_type",
                      values_to = "value") |>
  dplyr::mutate(
    effect_type = dplyr::recode(
        effect_type,
        "RE" = "Efecto tasa (RE)",
        "CE" = "Efecto composición (CE)")) |>
    group_by(region) |> 
    mutate(sum_diff = sum(diff_total)) |> ungroup() |> 
  ggplot(aes(x = value,
             y = fct_reorder(region, sum_diff),
             #fill = discapacidad,
             color = effect_type,
             group = effect_type)) +
    geom_col(position = "stack", fill = "white") +
    scale_color_manual(values = c(
      "Efecto tasa (RE)" = "black",
      "Efecto composición (CE)" = "red")) +
  labs(
    x = "Contribución a ΔR (p.p.)", y = NULL,
    #title = paste0("Nacional vs Region"),
    subtitle = "Calor y Discapacidad (Estructura)",
    fill = NULL,
    color = NULL) +
    #facet_wrap(~discapacidad, ncol = 6)+
    theme_bw()+
    theme(legend.position = "bottom")
```

Por estructura

```{r}
resumen_discapacidad |>
  tidyr::pivot_longer(c(RE, CE), 
                      names_to = "effect_type",
                      values_to = "value") |>
  dplyr::mutate(
    effect_type = dplyr::recode(
        effect_type,
        "RE" = "Efecto tasa (RE)",
        "CE" = "Efecto composición (CE)")) |>
    dplyr::mutate(
    dis = dplyr::recode(
        dis,
        #"popdis" = "Severe",
        "popnodis" = "Sin Discapacidad",
        "dis_mov" = "Movilidad",
        "dis_mult" = "Múltiple",
        "dis_otros" = "Otros")) |>
    group_by(region) |> 
    mutate(sum_diff = sum(diff_total)) |> ungroup() |>
    filter(dis != "Sin Discapacidad") |> 
  ggplot(aes(x = value,
             y = fct_reorder(dis, value),
             color = effect_type,
             group = effect_type)) +
    geom_col(position = "stack", fill = "white") +
  labs(
    x = NULL, y = NULL,
    #title = paste0("Nacional vs Region"),
    subtitle = "Discapacidad Severa",
    fill = NULL, color = NULL) +
     scale_color_manual(values = c(
      "Efecto tasa (RE)" = "black",
      "Efecto composición (CE)" = "red")) +
    facet_wrap(~fct_reorder(region, sum_diff),
               ncol = 2)+
    theme_void()+
    theme(legend.position = "bottom")
```

### 2. Métodos Simétricos: Das Gupta, Horiuchi, Stepwise Replacement

En una segunda etapa se aplicarán métodos simétricos de descomposición, capaces de manejar tres componentes simultáneamente (s–d–h).

El objetivo es desagregar las diferencias regionales totales en la exposición al calor de personas con discapacidad según las contribuciones de:

-   La estructura etaria (s),

-   La prevalencia de discapacidad (d),

-   La intensidad o frecuencia de días de calor (h).

-   …

Se prevé incorporar en etapas posteriores la descomposición por tipo de discapacidad y sexo extendiendo así el análisis multidimensional de vulnerabilidad.

```{r}
 discapacidades <- c(
     "popdis",
     "dis_mov",
     "dis_mult",
     "dis_otros")

datos <- list()

for (i in discapacidades) {
    
estatal <- df |>
  group_by(region, age5) |>
  summarise(
    S = sum(pop*366, na.rm = TRUE), # En días-persona
    D = sum(.data[[i]]*366, na.rm = TRUE), # En días-persona
    H = sum(pop*heatdays, na.rm = TRUE), # Días de calor CON DISCAPACIDAD
  ) |> ungroup() |> 
    group_by(region) |> 
  mutate(
      s = S / sum(S, na.rm = TRUE), # Estructura de edad
    d = D / S, # Tasa específica de discapacidad
    h = H / S) |> # Días de calor CON DISCAPACIDAD
    mutate(heatdays = sum(d*s*h)*366) |> 
  ungroup()

# Nacional
nacional <- df |>
  group_by(age5) |>
  summarise(
    S = sum(pop*366, na.rm = TRUE), # En días-persona
    D = sum(.data[[i]]*366, na.rm = TRUE), # En días-persona
    H = sum(pop*heatdays, na.rm = TRUE), # Días de calor CON DISCAPACIDAD
  ) |> ungroup() |> 
  mutate(
    region = "Nacional",
    s = S / sum(S, na.rm = TRUE), # Estructura de edad
    d = D / S, # Tasa específica de discapacidad
    h = H / S
) |> # Días de calor CON DISCAPACIDAD
    mutate(heatdays = sum(d*s*h)*366) |> 
    ungroup()

datos[[i]] <- bind_rows(estatal, nacional) |> 
    mutate(discapacidad = i)

}

datos <-  do.call(rbind, datos)
datos <- datos |> 
      mutate(age5 = factor(age5, c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+")))
```

Asegurando independencia

```{r}
discapacidades <- c(
  "popdis",
  "dis_mov",
  "dis_mult",
  "dis_otros")

age5_levels <- c(
  "0-4", "5-9", "10-14", "15-19", "20-24",
  "25-29", "30-34", "35-39", "40-44", "45-49",
  "50-54", "55-59", "60-64", "65-69", "70-74",
  "75-79", "80-84", "85+")

datos <- list()

for (i in discapacidades) {
  
## NIVEL ESTATAL
  estatal <- df |>
    group_by(region, age5) |>
    summarise(
      S = sum(pop, na.rm = TRUE),             # población total por edad
      D = sum(.data[[i]], na.rm = TRUE),      # personas con este tipo de discapacidad
      # promedio ponderado de días de calor por edad
      heatdays  = weighted.mean(heatdays, w = pop, na.rm = TRUE)) |>
      ungroup() |> 
    group_by(region) |>
    mutate(
      # Estructura de edad: sólo depende de la población por edad
      s = S / sum(S, na.rm = TRUE)
    ) |>
    ungroup() |>
    mutate(
      # Tasa específica de discapacidad: dis / pop (independiente de s)
      d = D / S,
      # Intensidad climática: días de calor como proporción del año
      h = heatdays / 366
    ) |>
    group_by(region) |>
    mutate(
      # Exposición total de la región para este tipo de discapacidad
      # (misma lógica que exposure_fun: sum(d * s * h * 100))
      exposure = sum(d * s * h * 100, na.rm = TRUE)
    ) |>
    ungroup() |>
    mutate(
      discapacidad = i
    )
  
  ## NIVEL NACIONAL
  nacional <- df |>
    group_by(age5) |>
    summarise(
      S       = sum(pop, na.rm = TRUE),
      D       = sum(.data[[i]], na.rm = TRUE),
      heatdays  = weighted.mean(heatdays, w = pop, na.rm = TRUE)) |>
    ungroup() |> 
      mutate(
      region = "Nacional"
    ) |>
    group_by(region) |>
    mutate(
      s = S / sum(S, na.rm = TRUE)
    ) |>
    ungroup() |>
    mutate(
      d = D / S,
      h = heatdays / 366
    ) |>
    group_by(region) |>
    mutate(
      exposure = sum(d * s * h * 100, na.rm = TRUE)
    ) |>
    ungroup() |>
    mutate(
      discapacidad = i
    )
  
  ## Guardamos estatal + nacional para este tipo de discapacidad
  datos[[i]] <- bind_rows(estatal, nacional)
}

## Unimos todo y ordenamos factores de edad
datos <- do.call(rbind, datos) |>
  mutate(
    age5 = factor(age5, levels = age5_levels)
  )
```

```{r}
# 1. Proporción del total de dias-persona por edad
datos |> 
    ggplot()+
    aes(x = s, y = age5,
        color = discapacidad, group = discapacidad)+
    geom_line(orientation = "y")+
    facet_wrap(~region)
# Las diferencias son las mismas por 

# 2. Proporción de días-persona de calor por edad
datos |> 
    ggplot()+
    aes(x = h, y = age5,
        color = discapacidad, group = discapacidad)+
    geom_line(orientation = "y")+
    facet_wrap(~region)

# 2. Prevalencia de discapacidad por edad + tipo de discapacidad
datos |> 
    filter(discapacidad != "popdis") |> 
    ggplot()+
    aes(x = d, y = age5,
        fill = discapacidad, group = discapacidad)+
    geom_area(orientation = "y")+
    geom_line(data = datos |> 
                  filter(discapacidad == "popdis"),
              color = "black",
              orientation = "y")+
    facet_wrap(~region)


# Tasas de calor (s*h) específicas por edad
datos |> 
    #filter(discapacidad != "popdis") |> 
    ggplot()+
    aes(y = age5,
        color = discapacidad, group = discapacidad)+
    geom_line(aes(x = s*h), orientation = "y")+
    geom_line(aes(x = s), orientation = "y",
              color = "red")+
    facet_wrap(~region)

# Tasas de discapacidad (s*d) específicas por edad
datos |> 
    #filter(discapacidad != "popdis") |> 
    ggplot()+
    aes(y = age5,
        color = discapacidad, group = discapacidad)+
    geom_line(aes(x = s*d), orientation = "y")+
    geom_line(aes(x = s), orientation = "y",
              color = "red")+
    facet_wrap(~region)

datos |> 
    filter(discapacidad != "popdis") |> 
    ggplot()+
    aes(x = s*d, y = age5,
        fill = discapacidad, group = discapacidad)+
    geom_area(orientation = "y")+
    geom_line(data = datos |> 
                  filter(discapacidad == "popdis"),
              color = "black",
              orientation = "y")+
    facet_wrap(~region)

datos |> 
    filter(discapacidad != "popdis") |> 
    ggplot()+
    aes(x = h*d, y = age5,
        fill = discapacidad, group = discapacidad)+
    geom_area(orientation = "y")+
    geom_line(data = datos |> 
                  filter(discapacidad == "popdis"),
              color = "black",
              orientation = "y")+
    facet_wrap(~region)
```

```{r}
#Exposición al calor con discapcidad por edad?
datos <- datos |> 
    mutate(specific_exp = s*d*h*100)


datos_decomp <- datos |> 
    filter(discapacidad != "popdis") |> 
    group_by(region) |> 
    mutate(exposure = sum(
        specific_exp, na.rm = T)) |> 
    ungroup()

datos_decomp |> 
    ggplot()+
    #Multiplicamos x 18 que es el numero de grupos de edad para alcanzar un valor similar al resumen total pero por grupo de edad
    aes(x = specific_exp*18, y = age5,
        fill = discapacidad,
        group = interaction(
            discapacidad, region))+

    geom_area(orientation = "y", color = "black")+
    #geom_col(position = "stack",
    #         color = "black", linewidth = .3)+
    geom_vline(aes(xintercept = exposure))+
    scale_fill_brewer(type = "qual",
                      palette = 1)+
    facet_wrap(~fct_reorder(region, exposure), 
               nrow = 6) +
    theme_bw()+
    theme(legend.position = "bottom")
```

```{r}
exposure_fun <- function(pars) {
  n <- length(pars) / 3
  s <- pars[1:n]
  d <- pars[(n + 1):(2 * n)]
  h <- pars[(2 * n + 1):(3 * n)]
  sum(d * s * h*100)
}

regiones <- names(table(datos_decomp$region))

ref <- regiones[18] # Nacional como referencia
regiones <- regiones[-18]

# Cambiar cuando se ven regiones
#ref <- regiones[3] # Nacional como referencia
#regiones <- regiones[-3]

# Lista de parámetros
data_list <- split(datos_decomp,
    datos_decomp$region)

parameters <- lapply(data_list, function(df) c(
    df$d, df$s, df$h))

#cambiar for por regiones
horiuchi <- list()
for (region in regiones) {
    horiuchi[[region]] <- DemoDecomp::horiuchi(
    func  = exposure_fun,
    pars1 = parameters[[ref]],
    pars2 = parameters[[region]],
    N = 40)
    }
```

```{r}
ids <- datos_decomp %>%
  filter(region == ref) %>%
  #arrange(age5, discapacidad) %>%
  mutate(id = paste0(age5, "__", discapacidad)) %>%
  pull(id)

param_names <- c(
  paste0("d__", ids),
  paste0("s__", ids),
  paste0("h__", ids))

# Asigna nombres a cada vector de contribuciones (por entidad ≠ ref)
for (region in regiones) {
  stopifnot(length(horiuchi[[region]]) == length(param_names))
  names(horiuchi[[region]]) <- param_names
}

horiuchi_df <- purrr::imap_dfr(
  horiuchi,
  ~ tibble(
      region = .y,
      parameter = names(.x),
      contribution = as.numeric(.x)
    )) |> 
  tidyr::separate(
      parameter,
      into = c(
          "component","age5","discapacidad"),
      sep = "__", convert = TRUE) %>%
  dplyr::mutate(
    age5 = factor(age5, levels = age5_levels),
    discapacidad = factor(
        discapacidad,
        levels = unique(datos_decomp$discapacidad)))
```

Contribuciones totales

```{r}
# Proportions or rates. What are we comparing?
global_results <- 
    cbind(
datos_decomp |> 
    group_by(region) |> 
    summarise(ref_exposure = unique(exposure)) |> 
    ungroup() |> 
    filter(region == "Nacional") |> 
    rename(ref_region = region),
datos_decomp |> 
    group_by(region) |> 
    summarise(exposure = unique(exposure)) |>
    ungroup() |> 
    filter(region != "Nacional"))

# Difference
global_results <- global_results |> 
    mutate(diff = exposure-ref_exposure,
           diffprop = diff/ref_exposure*100)

# Componentes
global_horiuchi <- horiuchi_df |> 
    group_by(region, component) |> 
    summarise(total_contribution = sum(contribution)) |>
    ungroup() 
    
global_results <- global_results|> 
    left_join(global_horiuchi,
              by = "region") |> 
    mutate(prop_contribution = total_contribution/ref_exposure*100)

# Resultados por commponente
global_results|> 
    group_by(component) |> 
    summarise(sd = sd(total_contribution),
              total_contribution = sum(total_contribution))


component_plot <- global_results |> 
    ggplot()+
    aes(x = prop_contribution,
                 y = fct_reorder(region, diff),
        fill = component)+
    geom_col(color = "black")+
    scale_fill_manual(values = c(
        "#4daf4a", "#e41a1c", "#377eb8"
    ))+
    #scale_fill_brewer(type = "qual",
                      #palette = 7,
                      #palette = 6)+
    theme_bw()+
    labs(y = NULL, x = "Contribution (%)")+
    theme(legend.position = "bottom")

component_plot

ggsave("out/decomposition.png",
       scale = .7,
       heigh = 10,
       width = 14,
       dpi = 300)

component_map <- global_results |> 
    left_join(mapa |> select(region = NOMGEO, geometry),
                  by = "region") |> 
    st_as_sf() |> 
    filter(component == "d") |> 
    ggplot()+
    geom_sf(aes(fill = diffprop))+
    scale_fill_continuous(palette = c(
        "darkblue", "white", "#e41a1c"))+
    #facet_wrap(~component, ncol = 1)+
    #scale_fill_brewer(type = "div")+
    #scale_fill_viridis_c()+
    theme_bw()+
    theme(legend.position = "bottom")

component_map

component_map+component_plot
```

```{r}
component_plot1 <- global_results |>       
    filter(component == "h") |> 
    ggplot()+
    aes(x = prop_contribution,
                 y = fct_reorder(
                     region, prop_contribution),
        fill = prop_contribution)+
    geom_col(color = "black")+
    scale_fill_continuous(palette = c(
        "white", "#e41a1c"))+
    labs(y = NULL, x = NULL)+
    facet_wrap(~component)+
    theme_bw()+
    theme(legend.position = "none")

component_map1 <- global_results |> 
    left_join(mapa |> select(region = NOMGEO, geometry),
                  by = "region") |> 
    st_as_sf() |> 
    filter(component == "h") |> 
    ggplot()+
    geom_sf(aes(fill = prop_contribution),
            color = "black")+
    labs(y = NULL, x = NULL)+
    facet_wrap(~component, ncol = 1)+
    scale_fill_continuous(palette = c(
        "white", "#e41a1c"))+
    theme_bw()+
    theme(legend.position = "bottom")

component_plot2 <- global_results |>       
    filter(component == "s") |> 
    ggplot()+
    aes(x = prop_contribution,
                 y = fct_reorder(
                     region, prop_contribution),
        fill = prop_contribution)+
    geom_col(color = "black")+
    scale_fill_continuous(palette = c(
        "white", "#377eb8"))+
    labs(y = NULL, x = NULL)+
    facet_wrap(~component)+
    theme_bw()+
    theme(legend.position = "none")

component_map2 <- global_results |> 
    left_join(mapa |> select(region = NOMGEO, geometry),
                  by = "region") |> 
    st_as_sf() |> 
    filter(component == "s") |> 
    ggplot()+
    geom_sf(aes(fill = prop_contribution),
            color = "black")+
    facet_wrap(~component, ncol = 1)+
    scale_fill_continuous(palette = c(
        "white", "#377eb8"))+
    labs(y = NULL, x = NULL)+
    theme_bw()+
    theme(legend.position = "bottom")

component_plot3 <- global_results |>       
    filter(component == "d") |> 
    ggplot()+
    aes(x = prop_contribution,
                 y = fct_reorder(
                     region, prop_contribution),
        fill = prop_contribution)+
    geom_col(color = "black")+
    scale_fill_continuous(palette = c(
        "white", "#4daf4a"))+
    facet_wrap(~component)+
    labs(y = NULL, x = NULL)+
    theme_bw()+
    theme(legend.position = "none")

component_map3 <- global_results |> 
    left_join(mapa |> select(region = NOMGEO, geometry),
                  by = "region") |> 
    st_as_sf() |> 
    filter(component == "d") |> 
    ggplot()+
    geom_sf(aes(fill = prop_contribution),
            color = "black")+
    facet_wrap(~component, ncol = 1)+
    scale_fill_continuous(palette = c(
        "white", "#4daf4a"))+
    theme_bw()+
    theme(legend.position = "bottom")

(component_plot1+component_map1)/
    (component_plot2+component_map2)/
    (component_plot3+component_map3)+
    plot_layout(widths = c(.5,1))

(component_map1+component_map2+component_map3)/
(component_plot1+component_plot2+component_plot3)+
    plot_layout(heights = c(.5,1))

ggsave("out/decomposition_states.png",
       scale = 1,
       heigh = 10,
       width = 14,
       dpi = 300)

component_plot/(component_map3+component_map1+component_map2)+
    plot_layout(heights = c(1,.5))
ggsave("out/decomposition_states2.png",
       scale = 1,
       heigh = 10,
       width = 14,
       dpi = 300)

```

Contribuciones por edad

```{r}
# Añadir todos los detalles estructurales
results <- global_results|> 
    left_join(horiuchi_df, by = c("region", "component"))

results <- results |> 
    mutate(prop_contribution = contribution/ref_exposure*100)

results |> 
    filter(region %in% c("Ciudad de México",
                         "Oaxaca")) |> 
    mutate(age5_num = as.numeric(str_extract(
        age5, "\\d+"))) |> 
    ggplot()+
    aes(y = prop_contribution,
                 x = age5_num, 
                 fill = component)+
    geom_col(
        color = "black",
             linewidth = .15) +
    scale_fill_brewer(type = "qual",
                      palette = 7)+
        facet_wrap(~fct_reorder(
            region, diff)+discapacidad,
            nrow = 2)+
    scale_y_continuous(n.breaks = 8)+
    scale_x_continuous(
        breaks = seq(0,85,5),
        labels = 
        c("", 5, rep("", times = 3),
          25, rep("", times = 3),
          45, rep("", times = 3),
          65, rep("", times = 3),
          "85+"))+
    theme_bw()

# ggsave("out/decomposition_structure.png",
#        scale = .9,
#        heigh = 8,
#        width = 12,
#        dpi = 300)

results |> 
    filter(region %in% c("Ciudad de México",
                         "Oaxaca")) |> 
    mutate(age5_num = as.numeric(str_extract(
        age5, "\\d+"))) |> 
    ggplot()+
    aes(y = contribution,
                 x = age5_num, 
                 fill = discapacidad)+
    geom_col(
        color = "black",
             linewidth = .15) +
    scale_fill_brewer(type = "qual",
                      palette = 7)+
        facet_wrap(~fct_reorder(
            region, diff*-1)+component,
            ncol = 3)+
    scale_y_continuous(n.breaks = 8)+
    scale_x_continuous(
        breaks = seq(0,85,5),
        labels = 
        c("", 5, rep("", times = 3),
          25, rep("", times = 3),
          45, rep("", times = 3),
          65, rep("", times = 3),
          "85+"))+
    theme_bw()+
    theme(panel.grid.minor = element_blank())

#ggsave("out/decomposition_structure_componente_facetas.png",
#       scale = .9,
#       heigh = 8,
#       width = 12,
#       dpi = 500)

age_structure <- results |> 
    group_by(region, component, age5) |> 
    summarise(prop_contribution = sum(prop_contribution),
              diff = sum(diff)) |> 
    ungroup() |> 
    filter(region %in% c("Ciudad de México",
                         "Nuevo León",
                         "San Luis Potosí",
                         "Oaxaca"
                         )) |> 
    mutate(age5_num = as.numeric(str_extract(
        age5, "\\d+"))) |> 
    ggplot()+
    aes(y = prop_contribution,
                 x = age5_num, 
                 fill = component)+
    geom_col(color = "black",
             linewidth = .25) +
    scale_fill_brewer(type = "qual",
                      palette = 7)+
    facet_wrap(~fct_reorder(region, diff*-1), nrow = 2)+
    scale_y_continuous(n.breaks = 8)+
    scale_x_continuous(
        breaks = seq(0,85,5),
        labels = 
        c("", 5, rep("", times = 3),
          25, rep("", times = 3),
          45, rep("", times = 3),
          65, rep("", times = 3),
          "85+"))+
    theme_bw()

dis_structure <- results |> 
    group_by(region, component, discapacidad) |> 
    summarise(prop_contribution = sum(prop_contribution),
              diff = sum(diff)) |> 
    ungroup() |> 
    filter(region %in% c("Ciudad de México",
                         "Chiapas",
                         "Oaxaca"
                         )) |> 
    ggplot()+
    aes(y = prop_contribution,
                 x = discapacidad, 
                 fill = component)+
    geom_col(color = "black",
             linewidth = .25) +
    scale_fill_brewer(type = "qual",
                      palette = 7)+
    facet_wrap(~fct_reorder(region, diff*-1), nrow = 3)+
    scale_y_continuous(n.breaks = 8)+
    theme_bw()

age_structure+dis_structure+
    plot_layout(widths = c(1,.3), guides = "collect")

ggsave(
    "out/decomposition_structure_componente_facetas.png",
      scale = .7,heigh = 8,width = 12,dpi = 500)

results |> 
group_by(region, component, discapacidad) |> 
    summarise(prop_contribution = sum(prop_contribution),
              diff = sum(diff)) |> 
    ungroup() |> 
    ggplot()+
    aes(x = prop_contribution,
                 y = fct_reorder(region, diff),
        fill = component)+
    geom_col(color = "black")+
    #scale_fill_manual(values = c(
    #    "#4daf4a", "#e41a1c", "#377eb8"
    #))+
    scale_fill_brewer(type = "qual",
                      palette = 7)+
    facet_wrap(~discapacidad)+
    theme_bw()+
    labs(y = NULL, x = "Contribution (%)")+
    theme(legend.position = "bottom")
```

### Comparativa

El objetivo central de esta sección es comparar dos enfoques clásicos

## Das Gupta

```{r}

source("R/data_decomposition.R")   
source("R/das_gupta.R")   


data_national <- df |>
  dplyr::bind_rows(
    df |> dplyr::mutate(region = "Nacional")
  )


data <- data_decomposition(data_national)


regions <- setdiff(unique(data$region), "Nacional")

results_rg <- purrr::map_dfr(
  regions,
  ~ das_gupta(
      df = data,
      ref_region = "Nacional",
      cmp_region = .x
    )
)


```

```{r}
#| label: Orden por región
norte <- c(
  "Baja California", "Baja California Sur", "Sonora", "Chihuahua",
  "Coahuila", "Nuevo León", "Tamaulipas", "Durango"
)

centro <- c(
  "Aguascalientes", "Zacatecas", "San Luis Potosí", "Guanajuato",
  "Querétaro", "Hidalgo", "Estado de México", "Ciudad de México",
  "Morelos", "Tlaxcala", "Puebla", "Michoacán", "Jalisco"
)

sur <- c(
  "Colima", "Nayarit", "Sinaloa", "Veracruz", "Guerrero",
  "Oaxaca", "Chiapas", "Tabasco", "Campeche", "Yucatán", "Quintana Roo"
)

orden_estados <- c(norte, centro, sur)

results_rg <- results_rg |>
  dplyr::mutate(
    exposure_rate = R_cmp   
  )

results_rg <- results_rg |> 
  dplyr::mutate(
    macroregion = dplyr::case_when(
      region %in% norte ~ "Norte",
      region %in% centro ~ "Centro",
      region %in% sur ~ "Sur",
      TRUE ~ NA_character_
    )
  )

orden_estados <- c(norte, centro, sur)


results_rg <- results_rg |> 
  dplyr::mutate(
    region = factor(region, levels = orden_estados),
    macroregion = factor(macroregion, levels = c("Norte","Centro","Sur"))
  ) |> 
  dplyr::arrange(macroregion, region)


```

```{r}
#| label: Tabla Das Gupta
results_rg |> 
  dplyr::select(
    macroregion,       
    region,
    exposure_rate,
    effect_heat,
    effect_age,
    effect_disability,
    total_diff
  ) |> 
  gt() |> 
  tab_header(
    title = "Das Gupta decomposition",
    subtitle = "Differences in extreme heat exposure"
  ) |> 
  cols_label(
    macroregion = "Region",
    region = "State",
    exposure_rate = "Exposure rate",
    effect_heat = "Heat effect",
    effect_age = "Age effect",
    effect_disability = "Disability effect",
    total_diff = "Total difference"
  ) |> 
  fmt_number(
    columns = c(exposure_rate, effect_heat, effect_age, effect_disability, total_diff),
    decimals = 6
  ) |> 
  data_color(
    columns = c(effect_heat, effect_age, effect_disability),
    colors = scales::col_numeric(
      palette = c("#2a9d8f", "white", "#d62828"),
      domain = c(-0.2, 0.2)
    )
  ) |> 
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) |> 
  tab_options(
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 12
  )
```



```{r}
#| label: Tabla Das Gupa
# library(htmltools)
# 
# # Preparar datos con indicadores de grupo
# results_rg_tabla <- results_rg |> 
#   dplyr::select(
#     macroregion,
#     region,
#     exposure_rate,
#     effect_heat,
#     effect_age,
#     effect_disability,
#     total_diff
#   ) |>
#   dplyr::group_by(macroregion) |>
#   dplyr::mutate(
#     primera_fila = dplyr::row_number() == 1,
#     n_filas = dplyr::n()
#   ) |>
#   dplyr::ungroup()
# 
# results_rg_tabla |>
#   gt() |> 
#   tab_header(
#     title = "Das Gupta decomposition",
#     subtitle = "Differences in extreme heat exposure"
#   ) |> 
#   cols_label(
#     macroregion = "Macro-region",
#     region = "State",
#     exposure_rate = "Exposure rate",
#     effect_heat = "Heat effect",
#     effect_age = "Age effect",
#     effect_disability = "Disability effect",
#     total_diff = "Total difference"
#   ) |>
#   cols_hide(columns = c(primera_fila, n_filas)) |>
#   text_transform(
#     locations = cells_body(columns = macroregion),
#     fn = function(x) {
#       idx <- which(results_rg_tabla$primera_fila)
#       result <- rep("", nrow(results_rg_tabla))
#       
#       for (i in idx) {
#         n <- results_rg_tabla$n_filas[i]
#         region_name <- results_rg_tabla$macroregion[i]
#         result[i] <- as.character(
#           tags$div(
#             style = sprintf(
#               "writing-mode: vertical-rl; 
#                text-orientation: mixed; 
#                font-weight: bold; 
#                font-size: 14px;
#                height: %dpx;
#                display: flex;
#                align-items: center;
#                justify-content: center;
#                margin: 0;
#                padding: 0;",
#               n * 35  # Ajusta este valor según la altura de tus filas
#             ),
#             region_name
#           )
#         )
#       }
#       result
#     }
#   ) |>
#   tab_style(
#     style = cell_borders(
#       sides = "right",
#       color = "#D3D3D3",
#       weight = px(1)
#     ),
#     locations = cells_body(columns = macroregion)
#   ) |>
#   fmt_number(
#     columns = c(exposure_rate, effect_heat, effect_age, effect_disability, total_diff),
#     decimals = 6
#   ) |> 
#   data_color(
#     columns = c(effect_heat, effect_age, effect_disability),
#     colors = scales::col_numeric(
#       palette = c("#2a9d8f", "white", "#d62828"),
#       domain = c(-0.2, 0.2)
#     )
#   ) |> 
#   tab_style(
#     style = cell_text(weight = "bold"),
#     locations = cells_column_labels()
#   ) |>
#   tab_options(
#     table.font.size = 12,
#     heading.title.font.size = 16,
#     heading.subtitle.font.size = 12
#   )
```

```{r}
# #| label: Tabla Das Gupta con flextable
# library(flextable)
# 
# results_rg |> 
#   dplyr::select(
#     macroregion,
#     region,
#     exposure_rate,
#     effect_heat,
#     effect_age,
#     effect_disability,
#     total_diff
#   ) |>
#   flextable() |>
#   set_header_labels(
#     macroregion = "Macro-region",
#     region = "State",
#     exposure_rate = "Exposure rate",
#     effect_heat = "Heat effect",
#     effect_age = "Age effect",
#     effect_disability = "Disability effect",
#     total_diff = "Total difference"
#   ) |>
#   merge_v(j = "macroregion") |>  # ¡Aquí está la magia!
#   valign(j = "macroregion", valign = "center") |>
#   bold(part = "header") |>
#   bold(j = "macroregion") |>
#   colformat_double(j = c("exposure_rate", "effect_heat", "effect_age", "effect_disability", "total_diff"), digits = 6) |>
#   add_header_lines(values = c("Das Gupta decomposition", "Differences in extreme heat exposure")) |>
#   theme_booktabs()
```



## Steepwise

## Horiuchi

```{r}
#| label: Hopriuchi con funciones
# source("R/prepare_horiuchi_data.R")
# source("R/run_horiuchi.R")
# source("R/process_horiuchi.R")
# source("R/horiuchi_global.R")
# 
# discapacidades <- c("popdis", "dis_mov", "dis_mult", "dis_otros")
# age5_levels <- c("0-4","5-9","10-14","15-19","20-24","25-29","30-34",
#                  "35-39","40-44","45-49","50-54","55-59","60-64",
#                  "65-69","70-74","75-79","80-84","85+")
# 
# horiuchi_raw  <- run_horiuchi(datos_decomp, age5_levels)
# horiuchi_df   <- process_horiuchi(horiuchi_raw, datos_decomp, age5_levels)

```

```{r}
exposure_table <- datos_decomp |>
  dplyr::group_by(region) |>
  dplyr::summarise(
    exposure_total = unique(exposure),
    .groups = "drop"
  ) |>
  dplyr::arrange(desc(exposure_total))

```

```{r}
exposure_table |> 
  dplyr::filter(!is.na(region)) |>  
  gt() |> 
  tab_header(
    title = "Exposición total al calor extremo"
  ) |> 
  fmt_number(
    columns = exposure_total,
    decimals = 6
  ) |> 
  sub_missing(
    columns = exposure_total,
    missing_text = ""
  ) |>
  data_color(
    columns = exposure_total,
    colors = scales::col_numeric(
      palette = c("#2a9d8f", "white", "#d62828"),
      domain = range(exposure_table$exposure_total, na.rm = TRUE),
      na.color = "white"
    )
  )
```

```{r}
#| label: Horiuchi por componente
effects_horiuchi <- horiuchi_df |>
  dplyr::group_by(region, component) |>
  dplyr::summarise(effect = sum(contribution), .groups = "drop") |>
  tidyr::pivot_wider(
    names_from = component,
    values_from = effect,
    names_prefix = "effect_"
  )


```

```{r}

exposure_table <- datos_decomp |>
  group_by(region) |>
  summarise(exposure_total = unique(exposure))

```

```{r}

ref_rate <- exposure_table |>
  filter(region == "Nacional") |>
  pull(exposure_total)

```

```{r}
horiuchi_results <- exposure_table |>
  filter(region != "Nacional") |>
  left_join(effects_horiuchi, by = "region") |>
  mutate(
    total_effects = effect_s + effect_d + effect_h,
    total_diff = exposure_total - ref_rate
  )

```


```{r}
horiuchi_results <- horiuchi_results |>
  dplyr::mutate(
    region = factor(region, levels = orden_estados)
  ) |>
  dplyr::arrange(region)
horiuchi_results |> 
  dplyr::select(
    region,
    effect_h,
    effect_s,
    effect_d,
    total_diff
  ) |>
  gt() |>
  tab_header(
    title = "Horiuchi decomposition",
    subtitle = "Differences in extreme heat exposure vs. Nacional"
  ) |> 
  cols_label(
    region = "State",
    effect_h = "Heat effect",
    effect_s = "Age effect",
    effect_d = "Disability effect",
    total_diff = "Total difference"
  )


```



```{r}
tasa_nacional_horiuchi <- datos_decomp |> 
    filter(region == "Nacional") |> 
    summarise(tasa = sum(s * d * h * 100)) |> 
    pull(tasa)

print(tasa_nacional_horiuchi)
```



## Tablas de cada método 

# Gráficas \[Anterior\]

### CONTRIBUCIONES POR REGIÓN

```{r}
fig_reg <- global |>
  select(dis, region, RE = rate_effect, CE = comp_effect) |>
  pivot_longer(c(RE, CE),
               names_to = "effect_type",
               values_to = "value_pp") |>
  mutate(
    effect_type = recode(
        effect_type,
        "RE" = "Efecto tasa (RE)",
        "CE" = "Efecto composición (CE)")) |>
  ggplot(aes(x = reorder(region, value_pp),
             y = value_pp, fill = effect_type)) +
  geom_col(position = "identity",) +
  coord_flip() +
  labs(
    x = NULL, y = "Contribución (p.p.)",
    title = "Kitagawa Nacional vs Región",
    subtitle = "Contribuciones por región",
    fill = NULL
  ) +
    facet_wrap(~dis, ncol = 1)+
  scale_fill_manual(values = c(
      "Efecto tasa (RE)" = "#4682B4",
      "Efecto composición (CE)" = "red")) +
  theme_minimal(base_size = 12)+
    theme(legend.position = "bottom")

fig_reg
```

```{r}
# Regiones
regiones <- names(table(datos[[1]]$region))

edad_contrib <- list()
edad_contrib_dis <- list()
for (j in 1:3) {
    for (i in regiones) {
    edad_contrib[[i]] <- contr_by_age(
        datos[[j]],
        group_A = "Nacional",
        group_B = i) |> 
        mutate(dis = datos_names[[j]])
    }
    edad_contrib_dis[[j]] <- do.call(rbind, edad_contrib)
        
}

edad_contrib_dis <- do.call(rbind, edad_contrib_dis)

fig_age <- edad_contrib_dis |>
  tidyr::pivot_longer(c(RE_pp, CE_pp), 
                      names_to = "effect_type",
                      values_to = "value_pp") |>
  dplyr::mutate(
    effect_type = dplyr::recode(
        effect_type,
        "RE_pp" = "Efecto tasa (RE)",
        "CE_pp" = "Efecto composición (CE)")
  ) |>
    mutate(age5 = factor(age5, c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+"))) |> 
    filter(region != "Nacional") |> 
  ggplot(aes(x = age5, y = value_pp,
             fill = effect_type)) +
  geom_col(position = "identity") +
  labs(
    x = NULL, y = "Contribución a ΔR (p.p.)",
    #title = paste0("Nacional vs Region"),
    #subtitle = "Descomposición de Kitagawa por edad",
    fill = NULL
  ) +
  scale_fill_manual(values = c(
      "Efecto tasa (RE)" = "#4682B4",
      "Efecto composición (CE)" = "red")) +
    facet_wrap(~region + dis, ncol = 6)+
    theme(legend.position = "bottom")+
  coord_flip()

fig_age
```
