---
format: html
editor: visual
code-fold: true
warning: false
editor_options: 
  chunk_output_type: console
---

# **Symmetric Methods**

Autores: Emerson (PI), Marcial y Carolina

## Introducción

Métodos simétricos de descomposición (Das Gupta, Horiuchi, y Stepwise Replacement) para descomponer simultáneamente los tres componentes (s–d–h) y estimar la contribución de cada uno a las diferencias observadas entre regiones.

## Paquetes

A continuación se cargan los paquetes necesarios:

```{r}
#| code-fold: false
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
    #Decomposition functions
    DemoDecomp,
    gtools, # permutations function for DasGupta's method 
    
    #Manipulation & analysis
    readr,readxl,
    janitor, dplyr,
    tidyr, tidyverse,
    purrr, # easy iterations
    scales, # Format numbers in graphics
    knitr, # Integrate code and narrative inside documents
    gt,#  Produce professional-quality tables
    rlang, #
    tibble, #
    # Data Viz
    ggplot2, patchwork,
    
    # For Spatial Data
    sf, ggmap, biscale)
```

## Datos

Cargamos base de datos de población y discapacidad

```{r}
df <- read_excel("in/POP_UTCI_mun.xlsx")
```

We get the geometries for Mexican States for visualization. Additionally, we use the names of this object for df

```{r}
mapa <- sf::read_sf("in/mapa_ent_small.shp")

df <- df |> 
    left_join(mapa |>
                  st_drop_geometry() |> 
                  select(cve_ent = CVE_ENT, NOMGEO),
              by = "cve_ent")
```

Some specifications are needed.

1\) Disabilities observed

2\) Region / Estates as comparison units

```{r}
# Nuevas categorías de discapacidad usadas
df <- df |> 
    mutate(dis_mov = dis_caminar+dis_banarse,
           dis_otros = dis_ver+dis_oir+dis_recordar+dis_hablar)

#Unidad de comparación
df <- df |> 
    select(-region) |> 
    rename(region = NOMGEO)
```

### Data aggregation

Assuring independence, we aggregate data by age and disability type for each region/state.

```{r}
discapacidades <- c("popdis",
                    "dis_mov",
                    "dis_mult",
                    "dis_otros")
  

age5_levels <- c(
  "0-4", "5-9", "10-14", "15-19", "20-24",
  "25-29", "30-34", "35-39", "40-44", "45-49",
  "50-54", "55-59", "60-64", "65-69", "70-74",
  "75-79", "80-84", "85+")

datos <- list()

for (i in discapacidades) {
  
## NIVEL ESTATAL
  estatal <- df |>
    group_by(region, age5) |>
    summarise(
      S = sum(pop, na.rm = TRUE),             # población total por edad
      D = sum(.data[[i]], na.rm = TRUE),      # personas con este tipo de discapacidad
      # promedio ponderado de días de calor por edad
      heatdays  = weighted.mean(heatdays, w = pop, na.rm = TRUE)) |>
      ungroup() |> 
    group_by(region) |>
    mutate(
      # Estructura de edad: sólo depende de la población por edad
      s = S / sum(S, na.rm = TRUE)
    ) |>
    ungroup() |>
    mutate(
      # Tasa específica de discapacidad: dis / pop (independiente de s)
      d = D / S,
      # Intensidad climática: días de calor como proporción del año
      h = heatdays / 366
    ) |>
    group_by(region) |>
    mutate(
      # Exposición total de la región para este tipo de discapacidad
      # (misma lógica que exposure_fun: sum(d * s * h * 100))
      exposure = sum(d * s * h * 100, na.rm = TRUE)
    ) |>
    ungroup() |>
    mutate(
      discapacidad = i
    )
  
  ## NIVEL NACIONAL
  nacional <- df |>
    group_by(age5) |>
    summarise(
      S       = sum(pop, na.rm = TRUE),
      D       = sum(.data[[i]], na.rm = TRUE),
      heatdays  = weighted.mean(heatdays, w = pop, na.rm = TRUE)) |>
    ungroup() |> 
      mutate(
      region = "Nacional"
    ) |>
    group_by(region) |>
    mutate(
      s = S / sum(S, na.rm = TRUE)
    ) |>
    ungroup() |>
    mutate(
      d = D / S,
      h = heatdays / 366
    ) |>
    group_by(region) |>
    mutate(
      exposure = sum(d * s * h * 100, na.rm = TRUE)
    ) |>
    ungroup() |>
    mutate(discapacidad = i)
  
  ## Guardamos estatal + nacional para este tipo de discapacidad
  datos[[i]] <- bind_rows(estatal, nacional)
}

## Unimos todo y ordenamos factores de edad
datos <- do.call(rbind, datos) |>
  mutate(
    age5 = factor(age5, levels = age5_levels)
  )
#Exposición al calor con discapcidad por edad?
datos <- datos |> 
    mutate(specific_exp = s*d*h*100)


datos_decomp <- datos |> 
    filter(discapacidad != "popdis") |> 
    group_by(region) |> 
    mutate(exposure = sum(
        specific_exp, na.rm = T)) |> 
    ungroup()
```

## Results

Definimos la categoría de referencia para la comparación

```{r}
regiones <- names(table(datos_decomp$region))

ref <- regiones[18] # Nacional como referencia
regiones <- regiones[-18]

# Cambiar cuando se ven regiones
#ref <- regiones[3] # Nacional como referencia
#regiones <- regiones[-3]
```

### Horiuchi

```{r}
exposure_fun <- function(pars) {
  n <- length(pars) / 3
  s <- pars[1:n]
  d <- pars[(n + 1):(2 * n)]
  h <- pars[(2 * n + 1):(3 * n)]
  sum(d * s * h*100)
}

# Lista de parámetros
data_list <- split(datos_decomp,
    datos_decomp$region)

parameters <- lapply(data_list, function(df) c(
    df$d, df$s, df$h))

#cambiar for por regiones
horiuchi <- list()
for (region in regiones) {
    horiuchi[[region]] <- DemoDecomp::horiuchi(
    func  = exposure_fun,
    pars1 = parameters[[ref]],
    pars2 = parameters[[region]],
    N = 6)
}

ids <- datos_decomp %>%
  filter(region == ref) %>%
  mutate(id = paste0(age5, "__", discapacidad)) %>%
  pull(id)

param_names <- c(
  paste0("d__", ids),
  paste0("s__", ids),
  paste0("h__", ids))

# Asigna nombres a cada vector de contribuciones (por entidad ≠ ref)
for (region in regiones) {
  stopifnot(length(horiuchi[[region]]) == length(param_names))
  names(horiuchi[[region]]) <- param_names
}

horiuchi_df <- purrr::imap_dfr(
  horiuchi,
  ~ tibble(
      region = .y,
      parameter = names(.x),
      contribution = as.numeric(.x)
    )) |> 
  tidyr::separate(
      parameter,
      into = c(
          "component","age5","discapacidad"),
      sep = "__", convert = TRUE) %>%
  dplyr::mutate(
    age5 = factor(age5, levels = age5_levels),
    discapacidad = factor(
        discapacidad,
        levels = discapacidades))
```

### Das Gupta

```{r}
source("R/das_gupta2.R")
das_gupta_list <- list()
for (region in regiones) {
    das_gupta_list[[region]] <- das_gupta(
        df = datos_decomp |> filter(
            region %in% c(ref, region)),
        ref = ref,
        cmp = region,
        region_var = region,
        strata_vars = c("age5", "discapacidad"),
        comp_vars = c("s", "d", "h"),
        scale = 100)
}

# Extraemos las contribuciones globales
global <- list()
for (region in regiones) {
    global[[region]] <- das_gupta_list[[region]]$global
}
global <- do.call(rbind, global) |> as.data.frame()

# Extraemos las contribuciones por cada categoría estructural
das_gupta_df <- list()
for (region in regiones) {
    das_gupta_df[[region]] <- das_gupta_list[[region]]$cell
}
das_gupta_df <- do.call(rbind, das_gupta_df) |>
    as.data.frame() |>
    mutate(discapacidad = factor(
        discapacidad, levels = discapacidades))
```

Contribuciones totales

```{r}
das_gupta_df <- das_gupta_df |> 
    arrange(cmp, age5, discapacidad, component)
horiuchi_df <- horiuchi_df |> 
    arrange(region, age5, discapacidad, component)

# Calculamos la diferencia entre ambos
das_gupta_df$effect-horiuchi_df$contribution
hist(das_gupta_df$effect-horiuchi_df$contribution)

das_gupta_df <- das_gupta_df |> 
    mutate(diff = effect-horiuchi_df$contribution)

das_gupta_df |> 
    ggplot()+
    geom_histogram(aes(x = diff)) +
    facet_wrap(~component, ncol = 1)

das_gupta_df |> 
    ggplot()+
    geom_histogram(aes(x = diff)) +
    facet_wrap(~age5, ncol = 5)

das_gupta_df |> 
    ggplot()+
    geom_histogram(aes(x = diff)) +
    facet_wrap(~cmp, ncol = 6)

das_gupta_df |> 
    group_by(component) |> 
    summarise(diff = mean(diff)) |> 
    ungroup() |> 
    ggplot()+
    geom_col(aes(x = diff, y = component))

das_gupta_df |> 
    group_by(age5) |> 
    summarise(diff = mean(diff)) |> 
    ungroup() |> 
    ggplot()+
    geom_col(aes(x = diff, y = age5))

das_gupta_df |> 
    group_by(cmp) |> 
    summarise(diff = mean(diff)) |> 
    ungroup() |> 
    ggplot()+
    geom_col(aes(x = diff, y = cmp))



# Observamos si hay diferencias totales sí sean iguales
deltaR_diff <- das_gupta_df |> 
    group_by(cmp) |> 
    summarise(deltaR = sum(effect)) |> 
    ungroup() |> 
    mutate(deltaR_horiuchi = (horiuchi_df |> 
               group_by(region) |> 
    summarise(deltaR = sum(contribution)) |> 
    ungroup() |> 
        pull(deltaR)))

deltaR_diff <- deltaR_diff |>
    mutate(deltaR_diff = deltaR-deltaR_horiuchi) 

deltaR_diff |> 
    ggplot()+
    geom_col(aes(x = deltaR_diff,
                 y = fct_reorder(cmp,deltaR_diff)))
```

```{r}
glimpse(das_gupta_df)
glimpse(horiuchi_df)




# Proportions or rates. What are we comparing?
global_results <- cbind(datos_decomp |> 
    group_by(region) |> 
    summarise(ref_exposure = unique(exposure)) |> 
    ungroup() |> 
    filter(region == "Nacional") |> 
    rename(ref_region = region),
datos_decomp |> 
    group_by(region) |> 
    summarise(exposure = unique(exposure)) |>
    ungroup() |> 
    filter(region != "Nacional"))

# Difference
global_results <- global_results |> 
    mutate(diff = exposure-ref_exposure,
           diffprop = diff/ref_exposure*100)

# Componentes
global_horiuchi <- horiuchi_df |> 
    group_by(region, component) |> 
    summarise(total_contribution = sum(contribution)) |>
    ungroup() 
    
global_results <- global_results|> 
    left_join(global_horiuchi,
              by = "region") |> 
    mutate(prop_contribution = total_contribution/ref_exposure*100)

# Resultados por commponente
global_results|> 
    group_by(component) |> 
    summarise(sd = sd(total_contribution),
              total_contribution = sum(total_contribution))

```

PLOTS

```{r}
component_plot <- global_results |> 
    ggplot()+
    aes(x = prop_contribution,
                 y = fct_reorder(region, diff),
        fill = component)+
    geom_col(color = "black")+
    scale_fill_manual(values = c(
        "#4daf4a", "#e41a1c", "#377eb8"
    ))+
    #scale_fill_brewer(type = "qual",
                      #palette = 7,
                      #palette = 6)+
    theme_bw()+
    labs(y = NULL, x = "Contribution (%)")+
    theme(legend.position = "bottom")

component_plot

ggsave("out/decomposition.png",
       scale = .7,
       heigh = 10,
       width = 14,
       dpi = 300)

component_map <- global_results |> 
    left_join(mapa |> select(region = NOMGEO, geometry),
                  by = "region") |> 
    st_as_sf() |> 
    filter(component == "d") |> 
    ggplot()+
    geom_sf(aes(fill = diffprop))+
    scale_fill_continuous(palette = c(
        "darkblue", "white", "#e41a1c"))+
    #facet_wrap(~component, ncol = 1)+
    #scale_fill_brewer(type = "div")+
    #scale_fill_viridis_c()+
    theme_bw()+
    theme(legend.position = "bottom")

component_map

component_map+component_plot
```

```{r}
component_plot1 <- global_results |>       
    filter(component == "h") |> 
    ggplot()+
    aes(x = prop_contribution,
                 y = fct_reorder(
                     region, prop_contribution),
        fill = prop_contribution)+
    geom_col(color = "black")+
    scale_fill_continuous(palette = c(
        "white", "#e41a1c"))+
    labs(y = NULL, x = NULL)+
    facet_wrap(~component)+
    theme_bw()+
    theme(legend.position = "none")

component_map1 <- global_results |> 
    left_join(mapa |> select(region = NOMGEO, geometry),
                  by = "region") |> 
    st_as_sf() |> 
    filter(component == "h") |> 
    ggplot()+
    geom_sf(aes(fill = prop_contribution),
            color = "black")+
    labs(y = NULL, x = NULL)+
    facet_wrap(~component, ncol = 1)+
    scale_fill_continuous(palette = c(
        "white", "#e41a1c"))+
    theme_bw()+
    theme(legend.position = "bottom")

component_plot2 <- global_results |>       
    filter(component == "s") |> 
    ggplot()+
    aes(x = prop_contribution,
                 y = fct_reorder(
                     region, prop_contribution),
        fill = prop_contribution)+
    geom_col(color = "black")+
    scale_fill_continuous(palette = c(
        "white", "#377eb8"))+
    labs(y = NULL, x = NULL)+
    facet_wrap(~component)+
    theme_bw()+
    theme(legend.position = "none")

component_map2 <- global_results |> 
    left_join(mapa |> select(region = NOMGEO, geometry),
                  by = "region") |> 
    st_as_sf() |> 
    filter(component == "s") |> 
    ggplot()+
    geom_sf(aes(fill = prop_contribution),
            color = "black")+
    facet_wrap(~component, ncol = 1)+
    scale_fill_continuous(palette = c(
        "white", "#377eb8"))+
    labs(y = NULL, x = NULL)+
    theme_bw()+
    theme(legend.position = "bottom")

component_plot3 <- global_results |>       
    filter(component == "d") |> 
    ggplot()+
    aes(x = prop_contribution,
                 y = fct_reorder(
                     region, prop_contribution),
        fill = prop_contribution)+
    geom_col(color = "black")+
    scale_fill_continuous(palette = c(
        "white", "#4daf4a"))+
    facet_wrap(~component)+
    labs(y = NULL, x = NULL)+
    theme_bw()+
    theme(legend.position = "none")

component_map3 <- global_results |> 
    left_join(mapa |> select(region = NOMGEO, geometry),
                  by = "region") |> 
    st_as_sf() |> 
    filter(component == "d") |> 
    ggplot()+
    geom_sf(aes(fill = prop_contribution),
            color = "black")+
    facet_wrap(~component, ncol = 1)+
    scale_fill_continuous(palette = c(
        "white", "#4daf4a"))+
    theme_bw()+
    theme(legend.position = "bottom")

(component_plot1+component_map1)/
    (component_plot2+component_map2)/
    (component_plot3+component_map3)+
    plot_layout(widths = c(.5,1))

(component_map1+component_map2+component_map3)/
(component_plot1+component_plot2+component_plot3)+
    plot_layout(heights = c(.5,1))

ggsave("out/decomposition_states.png",
       scale = 1,
       heigh = 10,
       width = 14,
       dpi = 300)

component_plot/(component_map3+component_map1+component_map2)+
    plot_layout(heights = c(1,.5))
ggsave("out/decomposition_states2.png",
       scale = 1,
       heigh = 10,
       width = 14,
       dpi = 300)

```

Contribuciones por edad

```{r}
# Añadir todos los detalles estructurales
results <- global_results|> 
    left_join(horiuchi_df, by = c("region", "component"))

results <- results |> 
    mutate(prop_contribution = contribution/ref_exposure*100)

results |> 
    filter(region %in% c("Ciudad de México",
                         "Oaxaca")) |> 
    mutate(age5_num = as.numeric(str_extract(
        age5, "\\d+"))) |> 
    ggplot()+
    aes(y = prop_contribution,
                 x = age5_num, 
                 fill = component)+
    geom_col(
        color = "black",
             linewidth = .15) +
    scale_fill_brewer(type = "qual",
                      palette = 7)+
        facet_wrap(~fct_reorder(
            region, diff)+discapacidad,
            nrow = 2)+
    scale_y_continuous(n.breaks = 8)+
    scale_x_continuous(
        breaks = seq(0,85,5),
        labels = 
        c("", 5, rep("", times = 3),
          25, rep("", times = 3),
          45, rep("", times = 3),
          65, rep("", times = 3),
          "85+"))+
    theme_bw()

# ggsave("out/decomposition_structure.png",
#        scale = .9,
#        heigh = 8,
#        width = 12,
#        dpi = 300)

results |> 
    filter(region %in% c("Ciudad de México",
                         "Oaxaca")) |> 
    mutate(age5_num = as.numeric(str_extract(
        age5, "\\d+"))) |> 
    ggplot()+
    aes(y = contribution,
                 x = age5_num, 
                 fill = discapacidad)+
    geom_col(
        color = "black",
             linewidth = .15) +
    scale_fill_brewer(type = "qual",
                      palette = 7)+
        facet_wrap(~fct_reorder(
            region, diff*-1)+component,
            ncol = 3)+
    scale_y_continuous(n.breaks = 8)+
    scale_x_continuous(
        breaks = seq(0,85,5),
        labels = 
        c("", 5, rep("", times = 3),
          25, rep("", times = 3),
          45, rep("", times = 3),
          65, rep("", times = 3),
          "85+"))+
    theme_bw()+
    theme(panel.grid.minor = element_blank())

#ggsave("out/decomposition_structure_componente_facetas.png",
#       scale = .9,
#       heigh = 8,
#       width = 12,
#       dpi = 500)

age_structure <- results |> 
    group_by(region, component, age5) |> 
    summarise(prop_contribution = sum(prop_contribution),
              diff = sum(diff)) |> 
    ungroup() |> 
    filter(region %in% c("Ciudad de México",
                         "Nuevo León",
                         "San Luis Potosí",
                         "Oaxaca"
                         )) |> 
    mutate(age5_num = as.numeric(str_extract(
        age5, "\\d+"))) |> 
    ggplot()+
    aes(y = prop_contribution,
                 x = age5_num, 
                 fill = component)+
    geom_col(color = "black",
             linewidth = .25) +
    scale_fill_brewer(type = "qual",
                      palette = 7)+
    facet_wrap(~fct_reorder(region, diff*-1), nrow = 2)+
    scale_y_continuous(n.breaks = 8)+
    scale_x_continuous(
        breaks = seq(0,85,5),
        labels = 
        c("", 5, rep("", times = 3),
          25, rep("", times = 3),
          45, rep("", times = 3),
          65, rep("", times = 3),
          "85+"))+
    theme_bw()

dis_structure <- results |> 
    group_by(region, component, discapacidad) |> 
    summarise(prop_contribution = sum(prop_contribution),
              diff = sum(diff)) |> 
    ungroup() |> 
    filter(region %in% c("Ciudad de México",
                         "Chiapas",
                         "Oaxaca"
                         )) |> 
    ggplot()+
    aes(y = prop_contribution,
                 x = discapacidad, 
                 fill = component)+
    geom_col(color = "black",
             linewidth = .25) +
    scale_fill_brewer(type = "qual",
                      palette = 7)+
    facet_wrap(~fct_reorder(region, diff*-1), nrow = 3)+
    scale_y_continuous(n.breaks = 8)+
    theme_bw()

age_structure+dis_structure+
    plot_layout(widths = c(1,.3), guides = "collect")

ggsave(
    "out/decomposition_structure_componente_facetas.png",
      scale = .7,heigh = 8,width = 12,dpi = 500)

results |> 
group_by(region, component, discapacidad) |> 
    summarise(prop_contribution = sum(prop_contribution),
              diff = sum(diff)) |> 
    ungroup() |> 
    ggplot()+
    aes(x = prop_contribution,
                 y = fct_reorder(region, diff),
        fill = component)+
    geom_col(color = "black")+
    #scale_fill_manual(values = c(
    #    "#4daf4a", "#e41a1c", "#377eb8"
    #))+
    scale_fill_brewer(type = "qual",
                      palette = 7)+
    facet_wrap(~discapacidad)+
    theme_bw()+
    labs(y = NULL, x = "Contribution (%)")+
    theme(legend.position = "bottom")
```

### Comparativa

El objetivo central de esta sección es comparar dos enfoques clásicos\*\*\*

## Das Gupta

```{r}

source("R/data_decomposition.R")   
source("R/das_gupta.R")   


data_national <- df |>
  dplyr::bind_rows(
    df |> dplyr::mutate(region = "Nacional")
  )


data <- data_decomposition(data_national)


regions <- setdiff(unique(data$region), "Nacional")

results_rg <- purrr::map_dfr(
  regions,
  ~ das_gupta(
      df = data,
      ref_region = "Nacional",
      cmp_region = .x
    ))
```

```{r}
#| label: Orden por región
norte <- c(
  "Baja California", "Baja California Sur", "Sonora", "Chihuahua",
  "Coahuila", "Nuevo León", "Tamaulipas", "Durango"
)

centro <- c(
  "Aguascalientes", "Zacatecas", "San Luis Potosí", "Guanajuato",
  "Querétaro", "Hidalgo", "Estado de México", "Ciudad de México",
  "Morelos", "Tlaxcala", "Puebla", "Michoacán", "Jalisco"
)

sur <- c(
  "Colima", "Nayarit", "Sinaloa", "Veracruz", "Guerrero",
  "Oaxaca", "Chiapas", "Tabasco", "Campeche", "Yucatán", "Quintana Roo"
)

orden_estados <- c(norte, centro, sur)

results_rg <- results_rg |>
  dplyr::mutate(
    exposure_rate = R_cmp   
  )

results_rg <- results_rg |> 
  dplyr::mutate(
    macroregion = dplyr::case_when(
      region %in% norte ~ "Norte",
      region %in% centro ~ "Centro",
      region %in% sur ~ "Sur",
      TRUE ~ NA_character_
    )
  )

orden_estados <- c(norte, centro, sur)


results_rg <- results_rg |> 
  dplyr::mutate(
    region = factor(region, levels = orden_estados),
    macroregion = factor(macroregion, levels = c("Norte","Centro","Sur"))
  ) |> 
  dplyr::arrange(macroregion, region)
```

```{r}
#| label: Tabla Das Gupta
results_rg |> 
  dplyr::select(
    macroregion,       
    region,
    exposure_rate,
    effect_heat,
    effect_age,
    effect_disability,
    total_diff
  ) |> 
  gt() |> 
  tab_header(
    title = "Das Gupta decomposition",
    subtitle = "Differences in extreme heat exposure"
  ) |> 
  cols_label(
    macroregion = "Region",
    region = "State",
    exposure_rate = "Exposure rate",
    effect_heat = "Heat effect",
    effect_age = "Age effect",
    effect_disability = "Disability effect",
    total_diff = "Total difference"
  ) |> 
  fmt_number(
    columns = c(exposure_rate, effect_heat, effect_age, effect_disability, total_diff),
    decimals = 6
  ) |> 
  data_color(
    columns = c(effect_heat, effect_age, effect_disability),
    colors = scales::col_numeric(
      palette = c("#2a9d8f", "white", "#d62828"),
      domain = c(-0.2, 0.2)
    )
  ) |> 
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) |> 
  tab_options(
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 12
  )
```

```{r}
#| label: Tabla Das Gupa
# library(htmltools)
# 
# # Preparar datos con indicadores de grupo
# results_rg_tabla <- results_rg |> 
#   dplyr::select(
#     macroregion,
#     region,
#     exposure_rate,
#     effect_heat,
#     effect_age,
#     effect_disability,
#     total_diff
#   ) |>
#   dplyr::group_by(macroregion) |>
#   dplyr::mutate(
#     primera_fila = dplyr::row_number() == 1,
#     n_filas = dplyr::n()
#   ) |>
#   dplyr::ungroup()
# 
# results_rg_tabla |>
#   gt() |> 
#   tab_header(
#     title = "Das Gupta decomposition",
#     subtitle = "Differences in extreme heat exposure"
#   ) |> 
#   cols_label(
#     macroregion = "Macro-region",
#     region = "State",
#     exposure_rate = "Exposure rate",
#     effect_heat = "Heat effect",
#     effect_age = "Age effect",
#     effect_disability = "Disability effect",
#     total_diff = "Total difference"
#   ) |>
#   cols_hide(columns = c(primera_fila, n_filas)) |>
#   text_transform(
#     locations = cells_body(columns = macroregion),
#     fn = function(x) {
#       idx <- which(results_rg_tabla$primera_fila)
#       result <- rep("", nrow(results_rg_tabla))
#       
#       for (i in idx) {
#         n <- results_rg_tabla$n_filas[i]
#         region_name <- results_rg_tabla$macroregion[i]
#         result[i] <- as.character(
#           tags$div(
#             style = sprintf(
#               "writing-mode: vertical-rl; 
#                text-orientation: mixed; 
#                font-weight: bold; 
#                font-size: 14px;
#                height: %dpx;
#                display: flex;
#                align-items: center;
#                justify-content: center;
#                margin: 0;
#                padding: 0;",
#               n * 35  # Ajusta este valor según la altura de tus filas
#             ),
#             region_name
#           )
#         )
#       }
#       result
#     }
#   ) |>
#   tab_style(
#     style = cell_borders(
#       sides = "right",
#       color = "#D3D3D3",
#       weight = px(1)
#     ),
#     locations = cells_body(columns = macroregion)
#   ) |>
#   fmt_number(
#     columns = c(exposure_rate, effect_heat, effect_age, effect_disability, total_diff),
#     decimals = 6
#   ) |> 
#   data_color(
#     columns = c(effect_heat, effect_age, effect_disability),
#     colors = scales::col_numeric(
#       palette = c("#2a9d8f", "white", "#d62828"),
#       domain = c(-0.2, 0.2)
#     )
#   ) |> 
#   tab_style(
#     style = cell_text(weight = "bold"),
#     locations = cells_column_labels()
#   ) |>
#   tab_options(
#     table.font.size = 12,
#     heading.title.font.size = 16,
#     heading.subtitle.font.size = 12
#   )
```

```{r}
# #| label: Tabla Das Gupta con flextable
# library(flextable)
# 
# results_rg |> 
#   dplyr::select(
#     macroregion,
#     region,
#     exposure_rate,
#     effect_heat,
#     effect_age,
#     effect_disability,
#     total_diff
#   ) |>
#   flextable() |>
#   set_header_labels(
#     macroregion = "Macro-region",
#     region = "State",
#     exposure_rate = "Exposure rate",
#     effect_heat = "Heat effect",
#     effect_age = "Age effect",
#     effect_disability = "Disability effect",
#     total_diff = "Total difference"
#   ) |>
#   merge_v(j = "macroregion") |>  # ¡Aquí está la magia!
#   valign(j = "macroregion", valign = "center") |>
#   bold(part = "header") |>
#   bold(j = "macroregion") |>
#   colformat_double(j = c("exposure_rate", "effect_heat", "effect_age", "effect_disability", "total_diff"), digits = 6) |>
#   add_header_lines(values = c("Das Gupta decomposition", "Differences in extreme heat exposure")) |>
#   theme_booktabs()
```

### por discapacidad

```{r}
tasas_discapacidad <- datos_decomp |> 
  group_by(region, discapacidad) |> 
  summarise(
    tasa = sum(specific_exp),
    .groups = "drop"
  )

split_data <- split(datos_decomp, datos_decomp$discapacidad)

resultados_list <- list()

for (disc in discapacidades) {
  
  df_k <- split_data[[disc]]
  
  res_k <- das_gupta(
    df = df_k,
    ref_region = "Nacional",
    cmp_region = "Aguascalientes"   # o un loop para todos
  ) |> 
    mutate(discapacidad = disc)
  
  resultados_list[[disc]] <- res_k
}

resultados_dg <- bind_rows(resultados_list)

regiones <- unique(datos_decomp$region)
regiones <- regiones[regiones != "Nacional"]

resultados_list <- list()

for (disc in discapacidades) {
  df_k <- split_data[[disc]]
  
  for (reg in regiones) {
    
    res_k <- das_gupta_threeway(
      df = df_k,
      ref_region = "Nacional",
      cmp_region = reg
    ) |> 
      mutate(
        discapacidad = disc,
        region = reg
      )
    
    resultados_list[[paste(disc, reg, sep="_")]] <- res_k
  }
}

resultados_dg <- bind_rows(resultados_list)


```

```{r}

discapacidades <- unique(datos_decomp$discapacidad)
split_data <- split(datos_decomp, datos_decomp$discapacidad)

regiones <- unique(datos_decomp$region)
regiones <- regiones[regiones != "Nacional"]

resultados_list <- list()

for (disc in discapacidades) {
  
  df_k <- split_data[[disc]]
  
  for (reg in regiones) {
    
    res_k <- das_gupta(
      df = df_k,
      ref_region = "Nacional",
      cmp_region = reg
    ) |> 
      mutate(
        discapacidad = disc,
        region = reg
      )
    
    resultados_list[[paste(disc, reg, sep = "_")]] <- res_k
  }
}

resultados_dg <- dplyr::bind_rows(resultados_list)

```

```{r}
resultados_dg |>
  select(region, discapacidad, effect_heat, effect_age, effect_disability, total_diff) |>
  arrange(discapacidad, region) |> 
  gt()

```

### Por edad

```{r}
df_mov <- datos_decomp |> 
  filter(discapacidad == "dis_mov")


```

```{r}

das_gupta_by_age <- function(df, ref_region, cmp_region) {
  
  A <- df |> 
    filter(region == ref_region) |> 
    select(age5, s_A = s, d_A = d, h_A = h)

  B <- df |> 
    filter(region == cmp_region) |> 
    select(age5, s_B = s, d_B = d, h_B = h)

  numeric_cols <- c("s_A","d_A","h_A","s_B","d_B","h_B")

  X <- full_join(A, B, by = "age5") |> 
    mutate(
      across(all_of(numeric_cols), ~as.numeric(as.character(.x))),
      across(all_of(numeric_cols), ~replace_na(.x, 0))
    ) #Cómo mcuhos?

  tibble(
    age5 = X$age5,
    
    effect_s_age = (X$s_B - X$s_A) *
      (X$d_A * X$h_A + X$d_B * X$h_B) / 2,
    
    effect_d_age = (X$d_B - X$d_A) *
      (X$s_A * X$h_A + X$s_B * X$h_B) / 2,
    
    effect_h_age = (X$h_B - X$h_A) *
      (X$s_A * X$d_A + X$s_B * X$d_B) / 2
  )
}



```

```{r}

res_ags_mov <- das_gupta_by_age(
  df = df_mov,
  ref_region = "Nacional",
  cmp_region = "Aguascalientes"
)


```

```{r}
discapacidades <- unique(datos_decomp$discapacidad)

resultados_age <- list()

for (disc in discapacidades) {

  df_k <- datos_decomp |> filter(discapacidad == disc)

  resultados_age[[disc]] <- das_gupta_by_age(
    df = df_k,
    ref_region = "Nacional",
    cmp_region = "Aguascalientes"
  ) |> mutate(discapacidad = disc)
}

resultados_age_df <- bind_rows(resultados_age)

resultados_age_df |> 
    View()

resultados_age_df |> 
    summarise(effect_s_age = sum(effect_s_age),
    effect_d_age = sum(effect_s_age),
    effect_h_age = sum(effect_s_age))

effects_horiuchi |> 
    mutate(contribucion = effect_d+effect_h+effect_s) |> 
    View()
```

```{r}
resultados_age_df |>
  mutate(age5 = factor(age5, levels = age5_levels)) |>
  arrange(discapacidad, age5) |>
  gt() |>
  tab_header(
    title = "Das Gupta by age — Aguascalientes",
    subtitle = "Separated by disability type"
  ) |>
  cols_label(
    discapacidad = "Disability type",
    age5 = "Age group",
    effect_s_age = "Age effect",
    effect_d_age = "Disability effect",
    effect_h_age = "Heat effect"
  ) |>
  fmt_number(
    columns = c(effect_s_age, effect_d_age, effect_h_age),
    decimals = 6
  )

```

## Steepwise

## Horiuchi

```{r}
#| label: Hopriuchi con funciones
# source("R/prepare_horiuchi_data.R")
# source("R/run_horiuchi.R")
# source("R/process_horiuchi.R")
# source("R/horiuchi_global.R")
# 
# discapacidades <- c("popdis", "dis_mov", "dis_mult", "dis_otros")
# age5_levels <- c("0-4","5-9","10-14","15-19","20-24","25-29","30-34",
#                  "35-39","40-44","45-49","50-54","55-59","60-64",
#                  "65-69","70-74","75-79","80-84","85+")
# 
# horiuchi_raw  <- run_horiuchi(datos_decomp, age5_levels)
# horiuchi_df   <- process_horiuchi(horiuchi_raw, datos_decomp, age5_levels)

```

```{r}
exposure_table <- datos_decomp |>
  dplyr::group_by(region) |>
  dplyr::summarise(
    exposure_total = unique(exposure),
    .groups = "drop"
  ) |>
  dplyr::arrange(desc(exposure_total))
```

```{r}
exposure_table |> 
  dplyr::filter(!is.na(region)) |>  
  gt() |> 
  tab_header(
    title = "Exposición total al calor extremo"
  ) |> 
  fmt_number(
    columns = exposure_total,
    decimals = 6
  ) |> 
  sub_missing(
    columns = exposure_total,
    missing_text = ""
  ) |>
  data_color(
    columns = exposure_total,
    colors = scales::col_numeric(
      palette = c("#2a9d8f", "white", "#d62828"),
      domain = range(exposure_table$exposure_total, na.rm = TRUE),
      na.color = "white"
    )
  )
```

```{r}
#| label: Horiuchi por componente
effects_horiuchi <- horiuchi_df |>
  dplyr::group_by(region, component) |>
  dplyr::summarise(effect = sum(contribution), .groups = "drop") |>
  tidyr::pivot_wider(
    names_from = component,
    values_from = effect,
    names_prefix = "effect_")
```

```{r}

exposure_table <- datos_decomp |>
  group_by(region) |>
  summarise(exposure_total = unique(exposure))
```

```{r}
ref_rate <- exposure_table |>
  filter(region == "Nacional") |>
  pull(exposure_total)
```

```{r}
horiuchi_results <- exposure_table |>
  filter(region != "Nacional") |>
  left_join(effects_horiuchi, by = "region") |>
  mutate(
    total_effects = effect_s + effect_d + effect_h,
    total_diff = exposure_total - ref_rate)
```

```{r}
horiuchi_results <- horiuchi_results |>
  dplyr::mutate(
    region = factor(region, levels = orden_estados)
  ) |>
  dplyr::arrange(region)

horiuchi_results |> 
  dplyr::select(
    region,
    effect_h,
    effect_s,
    effect_d,
    total_diff
  ) |>
  gt() |>
  tab_header(
    title = "Horiuchi decomposition",
    subtitle = "Differences in extreme heat exposure vs. Nacional"
  ) |> 
  cols_label(
    region = "State",
    effect_h = "Heat effect",
    effect_s = "Age effect",
    effect_d = "Disability effect",
    total_diff = "Total difference"
  )


```

```{r}
tasa_nacional_horiuchi <- datos_decomp |> 
    filter(region == "Nacional") |> 
    summarise(tasa = sum(s * d * h * 100)) |> 
    pull(tasa)

print(tasa_nacional_horiuchi)
```

### dis, edad

```{r}
estado <- "Aguascalientes"   

horiuchi_age_state <- horiuchi_df |>
  dplyr::filter(region == estado) |>
  dplyr::group_by(age5, discapacidad, component) |>
  dplyr::summarise(
    contribution = sum(contribution),
    .groups = "drop"
  ) |>
  tidyr::pivot_wider(
    names_from  = component,
    values_from = contribution,
    names_prefix = "effect_"
  )

horiuchi_age_state <- horiuchi_age_state |>
  dplyr::mutate(
    age5 = factor(age5, levels = age5_levels),
    discapacidad = factor(
      discapacidad,
      levels = c("dis_mov", "dis_mult", "dis_otros")
    )
  ) |>
  dplyr::arrange(discapacidad, age5)

horiuchi_age_state |>
  gt::gt() |>
  gt::tab_header(
    title = paste("Horiuchi decomposition by age —", estado),
    subtitle = "Effects by age and disability type"
  ) |>
  gt::cols_label(
    age5         = "Age group",
    discapacidad = "Disability type",
    effect_h     = "Heat effect (h)",
    effect_s     = "Age effect (s)",
    effect_d     = "Disability effect (d)"
  ) |>
  gt::fmt_number(
    columns = c(effect_h, effect_s, effect_d),
    decimals = 6
  )





```

## Tablas de cada método

Kitagawa

```{r}

tabla_final <- kitagawa_vs_ref(
  data        = datos[[1]],  # Solo popdis (discapacidad total/severa)
  group_col   = "region",
  stratum_col = "age5",      # ESTRUCTURA = edad
  ref         = "Nacional",
  rate_col    = "d",         # TASA = discapacidad
  struct_col  = "s"          # ESTRUCTURA = proporción por edad
) |> 
  select(
    Estado = region,
    Tasa_Nacional = R_A,           # Tasa cruda nacional
    Tasa_Estado = R_B,             # Tasa cruda del estado
    Diferencia = diff_total,       # R_A - R_B
    Efecto_Tasa = RE,              # Diferencia por tasas específicas
    Efecto_Composicion = CE,       # Diferencia por estructura etaria
    Pct_Efecto_Tasa = pct_RE,      # % explicado por tasa
    Pct_Efecto_Composicion = pct_CE # % explicado por composición
  )

# Ver la tabla
View(tabla_final)

```

# Gráficas \[Anterior\]

### CONTRIBUCIONES POR REGIÓN

```{r}
fig_reg <- global |>
  select(dis, region, RE = rate_effect, CE = comp_effect) |>
  pivot_longer(c(RE, CE),
               names_to = "effect_type",
               values_to = "value_pp") |>
  mutate(
    effect_type = recode(
        effect_type,
        "RE" = "Efecto tasa (RE)",
        "CE" = "Efecto composición (CE)")) |>
  ggplot(aes(x = reorder(region, value_pp),
             y = value_pp, fill = effect_type)) +
  geom_col(position = "identity",) +
  coord_flip() +
  labs(
    x = NULL, y = "Contribución (p.p.)",
    title = "Kitagawa Nacional vs Región",
    subtitle = "Contribuciones por región",
    fill = NULL
  ) +
    facet_wrap(~dis, ncol = 1)+
  scale_fill_manual(values = c(
      "Efecto tasa (RE)" = "#4682B4",
      "Efecto composición (CE)" = "red")) +
  theme_minimal(base_size = 12)+
    theme(legend.position = "bottom")

fig_reg
```

```{r}
# Regiones
regiones <- names(table(datos[[1]]$region))

edad_contrib <- list()
edad_contrib_dis <- list()
for (j in 1:3) {
    for (i in regiones) {
    edad_contrib[[i]] <- contr_by_age(
        datos[[j]],
        group_A = "Nacional",
        group_B = i) |> 
        mutate(dis = datos_names[[j]])
    }
    edad_contrib_dis[[j]] <- do.call(rbind, edad_contrib)
        
}

edad_contrib_dis <- do.call(rbind, edad_contrib_dis)

fig_age <- edad_contrib_dis |>
  tidyr::pivot_longer(c(RE_pp, CE_pp), 
                      names_to = "effect_type",
                      values_to = "value_pp") |>
  dplyr::mutate(
    effect_type = dplyr::recode(
        effect_type,
        "RE_pp" = "Efecto tasa (RE)",
        "CE_pp" = "Efecto composición (CE)")
  ) |>
    mutate(age5 = factor(age5, c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+"))) |> 
    filter(region != "Nacional") |> 
  ggplot(aes(x = age5, y = value_pp,
             fill = effect_type)) +
  geom_col(position = "identity") +
  labs(
    x = NULL, y = "Contribución a ΔR (p.p.)",
    #title = paste0("Nacional vs Region"),
    #subtitle = "Descomposición de Kitagawa por edad",
    fill = NULL
  ) +
  scale_fill_manual(values = c(
      "Efecto tasa (RE)" = "#4682B4",
      "Efecto composición (CE)" = "red")) +
    facet_wrap(~region + dis, ncol = 6)+
    theme(legend.position = "bottom")+
  coord_flip()

fig_age
```
